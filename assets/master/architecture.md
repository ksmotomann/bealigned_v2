Awesome—since Robert’s already got **Expo \+ React Native \+ Expo Router \+ React Hooks \+ Supabase (Auth/DB/Storage) \+ Supabase Edge Functions** running via **Claude Code/CLI**, here’s a **comprehensive, implementation-ready blueprint** to transplant the “brains” of **BeAligned™ Beta Lite** and **Flow (BeH2O® Coach companion)** into that stack.

I’ve split this into: architecture, folders, DB schema (with RLS), Edge Functions (AI \+ webhooks), client hooks, routing map, prompt “governance,” analytics, testing, and a phased delivery plan.

---

# **BeAligned™ \+ Flow — Expo/Supabase Blueprint**

## **1\) System Architecture (high level)**

* **Client (Expo RN)**: UI, local state, offline cache, streaming UI for AI.

* **Supabase Auth**: email/password or magic link; roles via JWT claims.

* **Postgres (Supabase DB)**: relational core \+ `pgvector` for semantic recall.

* **RLS Policies**: strict, role-scoped data access.

* **Supabase Edge Functions**:

  * `ai-reflect` (BeAligned phases)

  * `ai-clear` (CLEAR scoring & rewrite)

  * `ai-balance` (boundary coaching)

  * `stripe-webhooks` (billing)

  * `events-telemetry` (analytics)

* **Claude API** (via Edge Functions): prompt templates \+ governance injection.

* **Storage**: file uploads (images, PDFs, voice notes).

* **Optional**: Redis-like cache (Upstash) for rate-limits & idempotency.

---

## **2\) Repository / Folder Layout**

`apps/`  
  `mobile/                       # Expo app`  
    `app/                        # Expo Router`  
      `(auth)/`  
        `sign-in.tsx`  
        `sign-up.tsx`  
      `(main)/`  
        `index.tsx`  
        `reflections/`  
          `index.tsx`  
          `new.tsx`  
          `[id].tsx`  
        `messages/`  
          `index.tsx`  
          `draft.tsx`  
        `coach/`  
          `feedback/[id].tsx`  
      `_layout.tsx`  
    `src/`  
      `components/`  
      `hooks/`  
        `useSession.ts`  
        `useReflections.ts`  
        `useMessages.ts`  
        `useCoachFeedback.ts`  
        `useRealtime.ts`  
      `lib/`  
        `supabase.ts`  
        `queryClient.ts`  
        `storage.ts`  
        `secureStore.ts`  
      `styles/`  
      `state/`  
        `atoms.ts                # jotai/zustand if needed`  
      `utils/`  
        `validation.ts`  
        `formats.ts`  
    `assets/`  
    `app.config.ts`

`supabase/`  
  `migrations/                   # SQL`  
  `seed/`  
  `functions/`  
    `ai-reflect/index.ts`  
    `ai-clear/index.ts`  
    `ai-balance/index.ts`  
    `stripe-webhooks/index.ts`  
    `events-telemetry/index.ts`  
  `types/`  
    `database.types.ts           # generated by supabase CLI`

`packages/`  
  `prompts/                      # governance + prompt templates`  
    `governance.md`  
    `bealigned/`  
      `00_preamble.md`  
      `01_issue.md`  
      `02_feelings.md`  
      `03_why.md`  
      `04_perspective.md`  
      `05_options.md`  
      `06_choose.md`  
      `07_message.md`  
    `flow/`  
      `01_assess.md`  
      `02_prepare.md`  
      `03_limit.md`  
      `04_clear.md`  
      `05_yield.md`  
    `functions/`  
      `ai-templates.ts           # composes final system+user prompts`

`infra/`  
  `supabase/.env.example`  
  `expo/.env.example`  
  `scripts/`  
    `load-prompts.ts`  
    `create-policies.sql`

---

## **3\) Database Schema (Postgres/Supabase)**

### **3.1 Core Tables (SQL summary)**

`-- Users are in auth.users; mirror minimal profile data here`  
`create table public.profiles (`  
  `user_id uuid primary key references auth.users(id) on delete cascade,`  
  `first_name text,`  
  `last_name text,`  
  `preferred_name text,`  
  `time_zone text default 'America/Chicago',`  
  `role text check (role in ('parent','coach','admin','professional')) not null default 'parent',`  
  `created_at timestamptz default now()`  
`);`

`create table public.children (`  
  `id uuid primary key default gen_random_uuid(),`  
  `parent_user_id uuid not null references auth.users(id) on delete cascade,`  
  `name text not null,`  
  `birth_date date,`  
  `notes text,`  
  `wellbeing_indicators jsonb default '{}'::jsonb,`  
  `created_at timestamptz default now()`  
`);`

`create type reflection_phase as enum ('issue','feelings','why','perspective','options','choose','message');`

`create table public.reflections (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `phase reflection_phase not null,`  
  `content text not null,`  
  `ai_summary jsonb,`  
  `alignment_score numeric(4,2),`  
  `vector_embedding vector(1536), -- pgvector`  
  `created_at timestamptz default now(),`  
  `updated_at timestamptz default now()`  
`);`

`create table public.communications (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `type text check (type in ('draft','sent','received')) not null,`  
  `channel text check (channel in ('email','app_message','shared_link')) not null,`  
  `message_body text not null,`  
  `clear_score numeric(4,2),`  
  `target_audience text, -- e.g., 'co_parent','teacher','attorney'`  
  `created_at timestamptz default now()`  
`);`

`create table public.coach_feedback (`  
  `id uuid primary key default gen_random_uuid(),`  
  `coach_id uuid not null references auth.users(id) on delete cascade,`  
  `reflection_id uuid references public.reflections(id) on delete set null,`  
  `communication_id uuid references public.communications(id) on delete set null,`  
  `feedback_text text not null,`  
  `alignment_tags text[] default '{}',`  
  `created_at timestamptz default now()`  
`);`

`create table public.institutions (`  
  `id uuid primary key default gen_random_uuid(),`  
  `name text not null,`  
  `type text check (type in ('school','law_firm','court','nonprofit')) not null,`  
  `contact_email text,`  
  `created_at timestamptz default now()`  
`);`

`create table public.subscriptions (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid references auth.users(id) on delete cascade,`  
  `institution_id uuid references public.institutions(id) on delete cascade,`  
  `plan_tier text check (plan_tier in ('lite','pro','enterprise')) not null,`  
  `stripe_customer_id text,`  
  `stripe_subscription_id text,`  
  `status text check (status in ('active','past_due','canceled','trial')) not null default 'trial',`  
  `renewal_date date`  
`);`

`create table public.audit_logs (`  
  `id uuid primary key default gen_random_uuid(),`  
  `actor_user_id uuid references auth.users(id),`  
  `action text not null,`  
  `object_type text not null,`  
  `object_id uuid,`  
  `ip text,`  
  `metadata jsonb,`  
  `created_at timestamptz default now()`  
`);`

`-- Optional: aggregate alignment metrics`  
`create table public.alignment_metrics (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `session_id uuid,`  
  `alignment_score numeric(4,2),`  
  `clear_score numeric(4,2),`  
  `boundary_score numeric(4,2),`  
  `created_at timestamptz default now()`  
`);`

### **3.2 Row-Level Security (RLS)**

`alter table public.profiles enable row level security;`  
`alter table public.children enable row level security;`  
`alter table public.reflections enable row level security;`  
`alter table public.communications enable row level security;`  
`alter table public.coach_feedback enable row level security;`  
`alter table public.alignment_metrics enable row level security;`

`-- Current user convenience`  
`create or replace function auth.uid() returns uuid`  
`language sql stable as $$`  
  `select coalesce((select nullif(current_setting('request.jwt.claim.sub', true), '')::uuid), '00000000-0000-0000-0000-000000000000'::uuid);`  
`$$;`

`-- Profiles: a user can read/write only their own; coaches/admin can read all`  
`create policy "profiles self read" on public.profiles`  
`for select using (user_id = auth.uid() or exists (`  
  `select 1 from public.profiles p where p.user_id = auth.uid() and p.role in ('coach','admin')`  
`));`  
`create policy "profiles self write" on public.profiles`  
`for update using (user_id = auth.uid());`

`-- Reflections: owner can read/write; assigned coach can read`  
`alter table public.reflections add column coach_id uuid; -- nullable`  
`create policy "reflections owner read" on public.reflections`  
`for select using (user_id = auth.uid() or coach_id = auth.uid());`  
`create policy "reflections owner write" on public.reflections`  
`for insert with check (user_id = auth.uid())`  
`, for update using (user_id = auth.uid());`

`-- Communications similar to reflections`  
`create policy "comms owner read" on public.communications`  
`for select using (user_id = auth.uid());`  
`create policy "comms owner write" on public.communications`  
`for insert with check (user_id = auth.uid())`  
`, for update using (user_id = auth.uid());`

`-- Coach feedback: only coach author read/write + item owner can read`  
`create policy "feedback author read" on public.coach_feedback`  
`for select using (coach_id = auth.uid()`   
  `or exists(select 1 from reflections r where r.id = reflection_id and r.user_id = auth.uid())`  
  `or exists(select 1 from communications c where c.id = communication_id and c.user_id = auth.uid())`  
`);`  
`create policy "feedback author write" on public.coach_feedback`  
`for insert with check (coach_id = auth.uid())`  
`, for update using (coach_id = auth.uid());`

**Tip:** Add JWT custom claims for roles at login (via Supabase Auth hook) so RLS can branch on role without extra joins.

---

## **4\) Supabase Edge Functions (TypeScript)**

### **4.1 `ai-reflect` (BeAligned phases)**

**Purpose:** Accept a `phase` and `content`, inject governance \+ phase prompt, call Claude, return `ai_summary`, `alignment_score`, optional embedding.

Key steps:

1. Validate auth (Supabase client with service role only inside edge).

2. Compose prompt: governance preamble \+ phase template \+ user text.

3. Call Claude (streaming), parse tool/JSON blocks.

4. Persist `reflections` row; generate `vector_embedding` (via text-embedding model) and store.

5. Emit telemetry event.

**Skeleton:**

`import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';`  
`import { Hono } from 'https://esm.sh/hono';`  
`import { Anthropic } from 'npm:@anthropic-ai/sdk';`

`const app = new Hono();`

`app.post('/', async (c) => {`  
  `const supabase = createClient(Deno.env.get('SUPABASE_URL')!, Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!);`  
  `const { phase, content } = await c.req.json();`  
  `const user = c.req.header('x-user-id'); // pass from client via getSession`

  `// load prompt templates from storage or bundled file`  
  `const systemPreamble = await loadGovernance();`  
  `const phaseTemplate = await loadPhaseTemplate(phase);`

  `const anthropic = new Anthropic({ apiKey: Deno.env.get('ANTHROPIC_API_KEY')! });`  
  `const completion = await anthropic.messages.create({`  
    `model: 'claude-3-5-sonnet-latest',`  
    `max_tokens: 800,`  
    `system: systemPreamble,`  
    `messages: [`  
      `{ role: 'user', content: phaseTemplate.replace('{{INPUT}}', content) }`  
    `]`  
  `});`

  `const parsed = extractJSON(completion); // {summary, alignment_score}`  
  `const { data, error } = await supabase`  
    `.from('reflections')`  
    `.insert({`  
      `user_id: user,`  
      `phase,`  
      `content,`  
      `ai_summary: parsed.summary,`  
      `alignment_score: parsed.alignment_score`  
    `})`  
    `.select('id')`  
    `.single();`

  `// Optionally create embedding with another function`  
  `await enqueueEmbeddingJob(data.id, content);`

  `return c.json({ reflection_id: data.id, result: parsed });`  
`});`

`export default app;`

### **4.2 `ai-clear` (CLEAR scoring & rewrite)**

* Inputs: `message_body`, `target_audience`

* Outputs: `clear_score`, suggested rewrite, “listener-ready” checklist.

### **4.3 `ai-balance` (B.A.L.A.N.C.E. boundary helper)**

* Inputs: scenario text

* Outputs: structured boundary proposal (balanced, aligned, necessary, constructive, evolving), risk flags.

### **4.4 `stripe-webhooks`**

* Handle subscription lifecycle; update `subscriptions` table; set role gates.

### **4.5 `events-telemetry`**

* Buffer analytics (phase usage, avg scores). Store only anonymized fields.

---

## **5\) Client: Hooks & Data Flow (React Hooks)**

**Supabase client**

`// src/lib/supabase.ts`  
`import { createClient } from '@supabase/supabase-js';`  
`export const supabase = createClient(process.env.EXPO_PUBLIC_SUPABASE_URL!, process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY!, {`  
  `auth: { persistSession: true, autoRefreshToken: true, storage: /* SecureStore wrapper */ }`  
`});`

**Auth/session**

`// hooks/useSession.ts`  
`import { useEffect, useState } from 'react';`  
`import { supabase } from '../lib/supabase';`  
`export function useSession() {`  
  `const [session, setSession] = useState(null);`  
  `useEffect(() => {`  
    `supabase.auth.getSession().then(({ data }) => setSession(data.session));`  
    `return supabase.auth.onAuthStateChange((_e, s) => setSession(s)).data.subscription.unsubscribe;`  
  `}, []);`  
  `return session;`  
`}`

**Reflections**

`// hooks/useReflections.ts`  
`import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';`  
`import { supabase } from '../lib/supabase';`

`export function useReflections() {`  
  `const qc = useQueryClient();`  
  `const list = useQuery(['reflections'], async () => {`  
    `const { data, error } = await supabase.from('reflections').select('*').order('created_at', { ascending:false });`  
    `if (error) throw error; return data;`  
  `});`

  `const create = useMutation({`  
    `mutationFn: async ({ phase, content }) => {`  
      ``const res = await fetch(`${process.env.EXPO_PUBLIC_SUPABASE_EDGE_URL}/ai-reflect`, {``  
        `method: 'POST',`  
        `headers: { 'Content-Type':'application/json', 'x-user-id': (await supabase.auth.getUser()).data.user?.id ?? '' },`  
        `body: JSON.stringify({ phase, content })`  
      `});`  
      `return res.json();`  
    `},`  
    `onSuccess: () => qc.invalidateQueries({ queryKey:['reflections'] })`  
  `});`

  `return { list, create };`  
`}`

**Realtime (optional)**

* Subscribe to `coach_feedback` for live comments to a reflection.

---

## **6\) Routing Map (Expo Router)**

`/(auth)`  
`/(main)`  
`/(main)/reflections           -> list of sessions`  
`/main/reflections/new         -> phase stepper (issue→feelings→why→perspective→options→choose→message)`  
`/main/reflections/[id]        -> detail (AI summary, alignment score, coach feedback)`  
`/main/messages                -> drafts/sent; CLEAR tool`  
`/main/messages/draft          -> compose with CLEAR rewrite`  
`/main/coach/feedback/[id]     -> coach view on a reflection or message`

---

## **7\) Prompt Governance (portable \+ enforced)**

**`packages/prompts/governance.md` (excerpt)**

* Purpose: Safeguard childhoods; Alignment over neutrality

* Non-therapeutic, non-legal

* CLEAR: Concise, Listener-Ready, Essential, Appropriate, Relevant

* B.A.L.A.N.C.E.: Balanced, Aligned, Necessary, Constructive, Evolving (avoid “logical” framing)

* Third-Side hosting (Ury)

* Tone: trauma-informed, non-judgmental

* Output contracts: strict JSON schemas where needed

**Phase template example (`01_issue.md`)**

`SYSTEM REMINDER: Host the conflict; do not judge. Apply child-impact lens.`  
`User provided ISSUE:`  
`{{INPUT}}`

`Return JSON:`  
`{`  
  `"reframed_issue": string,`  
  `"assumptions_to_check": string[],`  
  `"child_impact_snapshot": string,`  
  `"next_prompt_hint": "feelings"`  
`}`

**CLEAR template (`flow/04_clear.md`)**

`Evaluate the draft for CLEAR:`  
`- Concise?`  
`- Listener-Ready?`  
`- Essential?`  
`- Appropriate?`  
`- Relevant?`

`Return JSON:`  
`{`  
  `"score": 0-10,`  
  `"edits": string[],`  
  `"rewritten_message": string`  
`}`

Edge functions import these files and compile **system \+ user** prompts to Claude.

---

## **8\) Analytics & Research Readiness**

* **Tables:** `alignment_metrics`, aggregated nightly by cron function.

* **KPIs:** avg alignment score per user over time, CLEAR improvement deltas, completion rates across phases.

* **Privacy:** store only derived metrics; raw text never leaves protected tables.

* **Dashboards:** simple RN views for coaches/admin; export CSV by request with consent.

---

## **9\) Security & Compliance**

* **RLS everywhere.** No client bypass.

* **JWT claims:** role \+ institution in `auth.jwt()` custom claim on sign-in.

* **PII minimization:** keep names/emails in `profiles`; reflections separate.

* **Encryption:** Supabase default \+ device SecureStore for tokens.

* **Audit logs:** write from Edge Functions for AI calls & admin actions.

* **Rate limiting:** per-user \+ per-ip via Upstash (keys: `ai:reflect:{user}:{h}`).

---

## **10\) Testing & QA**

* **Unit:** prompt compilers, JSON parsing, validators.

* **Integration:** Edge Functions (Deno test) with mock Anthropic.

* **E2E:** Detox for RN flows (auth → create reflection → AI summary → CLEAR rewrite).

* **Seed Data:** scripts with demo users, one coach, a few reflections/messages.

---

## **11\) Deployment & Env**

* **Envs:** `EXPO_PUBLIC_SUPABASE_URL`, `EXPO_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY` (edge only), `ANTHROPIC_API_KEY`, `EXPO_PUBLIC_SUPABASE_EDGE_URL`.

* **CI/CD:** GitHub Actions → supabase migrations → deploy functions → build Expo (EAS).

* **Backups:** Supabase PITR enabled; scheduled CSV exports for non-PII analytics.

---

## **12\) Phase Plan (2–3 sprints)**

**Sprint 1 (Core Reflection)**

* Migrations \+ RLS

* `ai-reflect` (issue→message)

* RN Phase Stepper, list/detail

* Basic CLEAR scoring in same function (optional)

**Sprint 2 (Coach & CLEAR)**

* `ai-clear`, `ai-balance` functions

* communications \+ coach\_feedback UIs

* Realtime subscriptions

* Alignment metrics

**Sprint 3 (Billing & Hardening)**

* Stripe webhooks

* Admin toggles (assign coach, institution)

* Rate limits, audit logs, E2E tests

* Offline-first polish

---

## **13\) What Robert can code next (very practical)**

1. **Run migrations** (RLS \+ schema above).

2. **Implement `ai-reflect` Edge Function** with governance \+ JSON outputs.

3. **Build RN Phase Stepper** that calls `useReflections().create({ phase, content })`.

4. **Render AI summary \+ alignment score** and save drafts to `communications`.

5. **Add `ai-clear`** for one-tap CLEAR rewrite before sending.

6. **Wire Realtime** for `coach_feedback`.

If you want, I can turn the SQL and Edge Function skeletons above into **ready-to-run files** (migrations \+ two edge functions \+ example RN screens) in your exact folder layout.

Here’s a ready-to-drop set of **SQL migration** and **Supabase Edge Function** files that align with the architecture we just mapped.

They’re formatted for the **Supabase CLI** project layout (`/supabase/migrations/` \+ `/supabase/functions/`).  
 The SQL creates the schema, constraints, and RLS; the Edge Functions implement `ai-reflect` and `ai-clear`.

---

## **🧱 1\. SQL — `/supabase/migrations/20251011_bealigned_init.sql`**

`-- === 1. ENUMS ===`  
`create type reflection_phase as enum (`  
  `'issue','feelings','why','perspective','options','choose','message'`  
`);`

`-- === 2. TABLES ===`  
`create table public.profiles (`  
  `user_id uuid primary key references auth.users(id) on delete cascade,`  
  `first_name text,`  
  `last_name text,`  
  `preferred_name text,`  
  `time_zone text default 'America/Chicago',`  
  `role text check (role in ('parent','coach','admin','professional')) not null default 'parent',`  
  `created_at timestamptz default now()`  
`);`

`create table public.children (`  
  `id uuid primary key default gen_random_uuid(),`  
  `parent_user_id uuid not null references auth.users(id) on delete cascade,`  
  `name text not null,`  
  `birth_date date,`  
  `notes text,`  
  `wellbeing_indicators jsonb default '{}'::jsonb,`  
  `created_at timestamptz default now()`  
`);`

`create table public.reflections (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `coach_id uuid references auth.users(id),`  
  `phase reflection_phase not null,`  
  `content text not null,`  
  `ai_summary jsonb,`  
  `alignment_score numeric(4,2),`  
  `vector_embedding vector(1536),`  
  `created_at timestamptz default now(),`  
  `updated_at timestamptz default now()`  
`);`

`create table public.communications (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `type text check (type in ('draft','sent','received')) not null,`  
  `channel text check (channel in ('email','app_message','shared_link')) not null,`  
  `message_body text not null,`  
  `clear_score numeric(4,2),`  
  `target_audience text,`  
  `created_at timestamptz default now()`  
`);`

`create table public.coach_feedback (`  
  `id uuid primary key default gen_random_uuid(),`  
  `coach_id uuid not null references auth.users(id) on delete cascade,`  
  `reflection_id uuid references public.reflections(id) on delete set null,`  
  `communication_id uuid references public.communications(id) on delete set null,`  
  `feedback_text text not null,`  
  `alignment_tags text[] default '{}',`  
  `created_at timestamptz default now()`  
`);`

`create table public.institutions (`  
  `id uuid primary key default gen_random_uuid(),`  
  `name text not null,`  
  `type text check (type in ('school','law_firm','court','nonprofit')) not null,`  
  `contact_email text,`  
  `created_at timestamptz default now()`  
`);`

`create table public.subscriptions (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid references auth.users(id) on delete cascade,`  
  `institution_id uuid references public.institutions(id) on delete cascade,`  
  `plan_tier text check (plan_tier in ('lite','pro','enterprise')) not null,`  
  `stripe_customer_id text,`  
  `stripe_subscription_id text,`  
  `status text check (status in ('active','past_due','canceled','trial')) not null default 'trial',`  
  `renewal_date date`  
`);`

`create table public.alignment_metrics (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `session_id uuid,`  
  `alignment_score numeric(4,2),`  
  `clear_score numeric(4,2),`  
  `boundary_score numeric(4,2),`  
  `created_at timestamptz default now()`  
`);`

`-- === 3. RLS UTILITIES ===`  
`create or replace function auth.uid() returns uuid`  
`language sql stable as $$`  
  `select nullif(current_setting('request.jwt.claim.sub', true), '')::uuid;`  
`$$;`

`-- === 4. ENABLE RLS ===`  
`alter table public.profiles enable row level security;`  
`alter table public.children enable row level security;`  
`alter table public.reflections enable row level security;`  
`alter table public.communications enable row level security;`  
`alter table public.coach_feedback enable row level security;`  
`alter table public.alignment_metrics enable row level security;`

`-- === 5. POLICIES ===`  
`create policy "profiles_self_read" on public.profiles`  
`for select using (user_id = auth.uid() or role in ('coach','admin'));`

`create policy "profiles_self_write" on public.profiles`  
`for update using (user_id = auth.uid());`

`create policy "reflections_owner_rw" on public.reflections`  
`for all using (user_id = auth.uid() or coach_id = auth.uid())`  
`with check (user_id = auth.uid());`

`create policy "comms_owner_rw" on public.communications`  
`for all using (user_id = auth.uid())`  
`with check (user_id = auth.uid());`

`create policy "feedback_visibility" on public.coach_feedback`  
`for select using (`  
  `coach_id = auth.uid() or`  
  `exists(select 1 from public.reflections r where r.id = reflection_id and r.user_id = auth.uid()) or`  
  `exists(select 1 from public.communications c where c.id = communication_id and c.user_id = auth.uid())`  
`);`

`create policy "feedback_author_rw" on public.coach_feedback`  
`for all using (coach_id = auth.uid()) with check (coach_id = auth.uid());`

---

## **⚙️ 2\. Edge Function — `/supabase/functions/ai-reflect/index.ts`**

`import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';`  
`import { Hono } from 'https://esm.sh/hono@3';`  
`import Anthropic from 'npm:@anthropic-ai/sdk@0.21.1';`

`const app = new Hono();`

`app.post('/', async (c) => {`  
  `const supabase = createClient(`  
    `Deno.env.get('SUPABASE_URL')!,`  
    `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!`  
  `);`

  `const { phase, content, user_id } = await c.req.json();`

  `// Load governance text from storage or inline constant`  
  `` const systemPrompt = ` ``  
`You are Flow, the BeH2O® Coach companion within BeAligned™.`  
`Purpose: Safeguard childhoods by promoting alignment over neutrality.`  
`Principles: CLEAR communication, B.A.L.A.N.C.E. boundaries, Third Side hosting.`  
`Output JSON strictly with summary and alignment_score.`  
`` `; ``

  `const anthropic = new Anthropic({ apiKey: Deno.env.get('ANTHROPIC_API_KEY')! });`

  `const message = await anthropic.messages.create({`  
    `model: 'claude-3-5-sonnet-latest',`  
    `system: systemPrompt,`  
    `max_tokens: 600,`  
    `messages: [`  
      `{`  
        `role: 'user',`  
        `` content: `Phase: ${phase}\nInput: ${content}\nReturn JSON { "summary": "...", "alignment_score": number(0-10) }` ``  
      `}`  
    `]`  
  `});`

  `const raw = message.content[0].text || '{}';`  
  `let parsed;`  
  `try { parsed = JSON.parse(raw); } catch { parsed = { summary: raw, alignment_score: null }; }`

  `const { data, error } = await supabase`  
    `.from('reflections')`  
    `.insert({`  
      `user_id,`  
      `phase,`  
      `content,`  
      `ai_summary: parsed.summary,`  
      `alignment_score: parsed.alignment_score`  
    `})`  
    `.select()`  
    `.single();`

  `if (error) return c.json({ error }, 500);`  
  `return c.json({ reflection: data });`  
`});`

`export default app;`

---

## **⚙️ 3\. Edge Function — `/supabase/functions/ai-clear/index.ts`**

`import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';`  
`import { Hono } from 'https://esm.sh/hono@3';`  
`import Anthropic from 'npm:@anthropic-ai/sdk@0.21.1';`

`const app = new Hono();`

`app.post('/', async (c) => {`  
  `const supabase = createClient(`  
    `Deno.env.get('SUPABASE_URL')!,`  
    `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!`  
  `);`

  `const { message_body, target_audience, user_id } = await c.req.json();`

  `` const systemPrompt = ` ``  
`You are Flow, evaluating a communication for CLEAR:`  
`Concise, Listener-Ready, Essential, Appropriate, Relevant.`  
`Return a JSON object { "clear_score": 0-10, "suggestions": [...], "rewritten_message": "..." }`  
`` `; ``

  `const anthropic = new Anthropic({ apiKey: Deno.env.get('ANTHROPIC_API_KEY')! });`

  `const completion = await anthropic.messages.create({`  
    `model: 'claude-3-5-sonnet-latest',`  
    `system: systemPrompt,`  
    `max_tokens: 700,`  
    `messages: [`  
      ``{ role: 'user', content: `Audience: ${target_audience}\nMessage:\n${message_body}` }``  
    `]`  
  `});`

  `const raw = completion.content[0].text || '{}';`  
  `let parsed;`  
  `try { parsed = JSON.parse(raw); } catch { parsed = { rewritten_message: raw }; }`

  `const { data, error } = await supabase`  
    `.from('communications')`  
    `.insert({`  
      `user_id,`  
      `type: 'draft',`  
      `channel: 'app_message',`  
      `message_body: parsed.rewritten_message || message_body,`  
      `clear_score: parsed.clear_score`  
    `})`  
    `.select()`  
    `.single();`

  `if (error) return c.json({ error }, 500);`  
  `return c.json({ communication: data, analysis: parsed });`  
`});`

`export default app;`

---

### **✅ Deployment steps**

Copy the SQL into `/supabase/migrations/20251011_bealigned_init.sql`

 `supabase db push`

1.   
2. Place each Edge Function in its own folder under `/supabase/functions/`.

Deploy:

 `supabase functions deploy ai-reflect`  
`supabase functions deploy ai-clear`

3. 

On the client (React Native), call:

 ``const res = await fetch(`${SUPABASE_URL}/functions/v1/ai-reflect`, {``  
  `method:'POST',`  
  `headers:{'Content-Type':'application/json'},`  
  `body: JSON.stringify({ phase:'issue', content:'We keep arguing about pickups', user_id })`  
`});`

4. `const data = await res.json();`

yes, create ai-balance edge function

###### **ChatGPT said:**

Perfect — here’s the **`ai-balance`** Edge Function built for your **Supabase \+ Claude Code** environment.  
 It fully implements the **B.A.L.A.N.C.E. boundary framework** (Balanced, Aligned, Necessary, Constructive, Evolving) while maintaining BeH2O® tone and governance.

This version:

* Mirrors your existing Edge Function structure (`Hono` \+ Supabase \+ Anthropic SDK)

* Returns structured JSON for easy use in the React Native client

* Automatically writes summarized boundary recommendations into the DB

* Enforces the *child-impact and alignment lens*

---

## **⚙️ `/supabase/functions/ai-balance/index.ts`**

`/**`  
 `* ai-balance Edge Function`  
 `* Purpose: Analyze a co-parenting or professional scenario and return a B.A.L.A.N.C.E. boundary recommendation`  
 `* Framework: Balanced, Aligned, Necessary, Constructive, Evolving`  
 `* Voice: Flow, the BeH2O® Coach Companion`  
 `*/`

`import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';`  
`import { Hono } from 'https://esm.sh/hono@3';`  
`import Anthropic from 'npm:@anthropic-ai/sdk@0.21.1';`

`const app = new Hono();`

`app.post('/', async (c) => {`  
  `const supabase = createClient(`  
    `Deno.env.get('SUPABASE_URL')!,`  
    `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!`  
  `);`

  `const { scenario_text, user_id } = await c.req.json();`

  `` const systemPrompt = ` ``  
`You are Flow, the BeH2O® Coach Companion within BeAligned™.`  
`Your role is to help users establish boundaries that are:`  
`- **Balanced**: mutual, not one-sided`  
`- **Aligned**: rooted in shared goals and safeguarding childhoods`  
`- **Necessary**: essential for stability and clarity, not punitive or excessive`  
`- **Constructive**: framed toward solutions, not blame`  
`- **Evolving**: adaptable as the child or situation grows`

`Tone and focus:`  
`- Be calm, reflective, and child-centered.`  
`- Avoid judgmental or diagnostic language.`  
`- Always consider the impact on the child's well-being.`  
`- End with a short reflection question for user growth.`

`Output STRICT JSON:`  
`{`  
  `"summary": string,`  
  `"recommendation": string,`  
  `"balance_check": {`  
    `"balanced": boolean,`  
    `"aligned": boolean,`  
    `"necessary": boolean,`  
    `"constructive": boolean,`  
    `"evolving": boolean`  
  `},`  
  `"child_impact_statement": string,`  
  `"reflection_prompt": string`  
`}`  
`` `; ``

  `try {`  
    `const anthropic = new Anthropic({ apiKey: Deno.env.get('ANTHROPIC_API_KEY')! });`

    `const completion = await anthropic.messages.create({`  
      `model: 'claude-3-5-sonnet-latest',`  
      `system: systemPrompt,`  
      `max_tokens: 900,`  
      `messages: [`  
        `{`  
          `role: 'user',`  
          `` content: `Scenario:\n${scenario_text}\nReturn your analysis strictly as JSON.` ``  
        `}`  
      `]`  
    `});`

    `const raw = completion.content?.[0]?.text || '{}';`  
    `let parsed;`  
    `try {`  
      `parsed = JSON.parse(raw);`  
    `} catch {`  
      `parsed = {`  
        `summary: raw,`  
        `recommendation: "Boundary not parsed; please retry.",`  
        `balance_check: {},`  
        `child_impact_statement: "",`  
        `reflection_prompt: ""`  
      `};`  
    `}`

    `// Write to DB`  
    `const { data, error } = await supabase`  
      `.from('reflections')`  
      `.insert({`  
        `user_id,`  
        `phase: 'message', -- reuse message phase as endpoint`  
        `content: scenario_text,`  
        `ai_summary: parsed,`  
        `alignment_score: null`  
      `})`  
      `.select()`  
      `.single();`

    `if (error) {`  
      `console.error(error);`  
      `return c.json({ error }, 500);`  
    `}`

    `return c.json({ result: parsed, record: data });`  
  `} catch (err) {`  
    `console.error(err);`  
    `return c.json({ error: String(err) }, 500);`  
  `}`  
`});`

`export default app;`

---

## **📤 Example Client Call (React Native)**

``const res = await fetch(`${SUPABASE_URL}/functions/v1/ai-balance`, {``  
  `method: 'POST',`  
  `headers: { 'Content-Type': 'application/json' },`  
  `body: JSON.stringify({`  
    `scenario_text: "My co-parent drops by unannounced during my parenting time. I don’t want to cause a scene in front of our child, but it’s disruptive.",`  
    `user_id: session.user.id`  
  `}),`  
`});`  
`const { result } = await res.json();`  
`console.log(result.recommendation);`

**Example Output:**

`{`  
  `"summary": "Parent feels intruded upon but wants to maintain peace.",`  
  `"recommendation": "Agree on a shared check-in method before visits. Each parent will text first to ensure timing works for the child.",`  
  `"balance_check": {`  
    `"balanced": true,`  
    `"aligned": true,`  
    `"necessary": true,`  
    `"constructive": true,`  
    `"evolving": true`  
  `},`  
  `"child_impact_statement": "Predictable transitions support the child’s sense of safety.",`  
  `"reflection_prompt": "How can you uphold this boundary while still modeling respect for the co-parent’s role?"`  
`}`

---

## **🧩 Deployment Notes**

`supabase functions deploy ai-balance`  
`supabase functions list`

✅ Requires:

* `SUPABASE_SERVICE_ROLE_KEY`

* `OPENAI_API_KEY`

