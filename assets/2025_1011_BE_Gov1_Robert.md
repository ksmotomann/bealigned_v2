Awesome—since Robert’s already got **Expo \+ React Native \+ Expo Router \+ React Hooks \+ Supabase (Auth/DB/Storage) \+ Supabase Edge Functions** running via **Claude Code/CLI**, here’s a **comprehensive, implementation-ready blueprint** to transplant the “brains” of **BeAligned™ Beta Lite** and **Flow (BeH2O® Coach companion)** into that stack.

I’ve split this into: architecture, folders, DB schema (with RLS), Edge Functions (AI \+ webhooks), client hooks, routing map, prompt “governance,” analytics, testing, and a phased delivery plan.

---

# **BeAligned™ \+ Flow — Expo/Supabase Blueprint**

## **1\) System Architecture (high level)**

* **Client (Expo RN)**: UI, local state, offline cache, streaming UI for AI.

* **Supabase Auth**: email/password or magic link; roles via JWT claims.

* **Postgres (Supabase DB)**: relational core \+ `pgvector` for semantic recall.

* **RLS Policies**: strict, role-scoped data access.

* **Supabase Edge Functions**:

  * `ai-reflect` (BeAligned phases)

  * `ai-clear` (CLEAR scoring & rewrite)

  * `ai-balance` (boundary coaching)

  * `stripe-webhooks` (billing)

  * `events-telemetry` (analytics)

* **Claude API** (via Edge Functions): prompt templates \+ governance injection.

* **Storage**: file uploads (images, PDFs, voice notes).

* **Optional**: Redis-like cache (Upstash) for rate-limits & idempotency.

---

## **2\) Repository / Folder Layout**

`apps/`  
  `mobile/                       # Expo app`  
    `app/                        # Expo Router`  
      `(auth)/`  
        `sign-in.tsx`  
        `sign-up.tsx`  
      `(main)/`  
        `index.tsx`  
        `reflections/`  
          `index.tsx`  
          `new.tsx`  
          `[id].tsx`  
        `messages/`  
          `index.tsx`  
          `draft.tsx`  
        `coach/`  
          `feedback/[id].tsx`  
      `_layout.tsx`  
    `src/`  
      `components/`  
      `hooks/`  
        `useSession.ts`  
        `useReflections.ts`  
        `useMessages.ts`  
        `useCoachFeedback.ts`  
        `useRealtime.ts`  
      `lib/`  
        `supabase.ts`  
        `queryClient.ts`  
        `storage.ts`  
        `secureStore.ts`  
      `styles/`  
      `state/`  
        `atoms.ts                # jotai/zustand if needed`  
      `utils/`  
        `validation.ts`  
        `formats.ts`  
    `assets/`  
    `app.config.ts`

`supabase/`  
  `migrations/                   # SQL`  
  `seed/`  
  `functions/`  
    `ai-reflect/index.ts`  
    `ai-clear/index.ts`  
    `ai-balance/index.ts`  
    `stripe-webhooks/index.ts`  
    `events-telemetry/index.ts`  
  `types/`  
    `database.types.ts           # generated by supabase CLI`

`packages/`  
  `prompts/                      # governance + prompt templates`  
    `governance.md`  
    `bealigned/`  
      `00_preamble.md`  
      `01_issue.md`  
      `02_feelings.md`  
      `03_why.md`  
      `04_perspective.md`  
      `05_options.md`  
      `06_choose.md`  
      `07_message.md`  
    `flow/`  
      `01_assess.md`  
      `02_prepare.md`  
      `03_limit.md`  
      `04_clear.md`  
      `05_yield.md`  
    `functions/`  
      `ai-templates.ts           # composes final system+user prompts`

`infra/`  
  `supabase/.env.example`  
  `expo/.env.example`  
  `scripts/`  
    `load-prompts.ts`  
    `create-policies.sql`

---

## **3\) Database Schema (Postgres/Supabase)**

### **3.1 Core Tables (SQL summary)**

`-- Users are in auth.users; mirror minimal profile data here`  
`create table public.profiles (`  
  `user_id uuid primary key references auth.users(id) on delete cascade,`  
  `first_name text,`  
  `last_name text,`  
  `preferred_name text,`  
  `time_zone text default 'America/Chicago',`  
  `role text check (role in ('parent','coach','admin','professional')) not null default 'parent',`  
  `created_at timestamptz default now()`  
`);`

`create table public.children (`  
  `id uuid primary key default gen_random_uuid(),`  
  `parent_user_id uuid not null references auth.users(id) on delete cascade,`  
  `name text not null,`  
  `birth_date date,`  
  `notes text,`  
  `wellbeing_indicators jsonb default '{}'::jsonb,`  
  `created_at timestamptz default now()`  
`);`

`create type reflection_phase as enum ('issue','feelings','why','perspective','options','choose','message');`

`create table public.reflections (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `phase reflection_phase not null,`  
  `content text not null,`  
  `ai_summary jsonb,`  
  `alignment_score numeric(4,2),`  
  `vector_embedding vector(1536), -- pgvector`  
  `created_at timestamptz default now(),`  
  `updated_at timestamptz default now()`  
`);`

`create table public.communications (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `type text check (type in ('draft','sent','received')) not null,`  
  `channel text check (channel in ('email','app_message','shared_link')) not null,`  
  `message_body text not null,`  
  `clear_score numeric(4,2),`  
  `target_audience text, -- e.g., 'co_parent','teacher','attorney'`  
  `created_at timestamptz default now()`  
`);`

`create table public.coach_feedback (`  
  `id uuid primary key default gen_random_uuid(),`  
  `coach_id uuid not null references auth.users(id) on delete cascade,`  
  `reflection_id uuid references public.reflections(id) on delete set null,`  
  `communication_id uuid references public.communications(id) on delete set null,`  
  `feedback_text text not null,`  
  `alignment_tags text[] default '{}',`  
  `created_at timestamptz default now()`  
`);`

`create table public.institutions (`  
  `id uuid primary key default gen_random_uuid(),`  
  `name text not null,`  
  `type text check (type in ('school','law_firm','court','nonprofit')) not null,`  
  `contact_email text,`  
  `created_at timestamptz default now()`  
`);`

`create table public.subscriptions (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid references auth.users(id) on delete cascade,`  
  `institution_id uuid references public.institutions(id) on delete cascade,`  
  `plan_tier text check (plan_tier in ('lite','pro','enterprise')) not null,`  
  `stripe_customer_id text,`  
  `stripe_subscription_id text,`  
  `status text check (status in ('active','past_due','canceled','trial')) not null default 'trial',`  
  `renewal_date date`  
`);`

`create table public.audit_logs (`  
  `id uuid primary key default gen_random_uuid(),`  
  `actor_user_id uuid references auth.users(id),`  
  `action text not null,`  
  `object_type text not null,`  
  `object_id uuid,`  
  `ip text,`  
  `metadata jsonb,`  
  `created_at timestamptz default now()`  
`);`

`-- Optional: aggregate alignment metrics`  
`create table public.alignment_metrics (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `session_id uuid,`  
  `alignment_score numeric(4,2),`  
  `clear_score numeric(4,2),`  
  `boundary_score numeric(4,2),`  
  `created_at timestamptz default now()`  
`);`

### **3.2 Row-Level Security (RLS)**

`alter table public.profiles enable row level security;`  
`alter table public.children enable row level security;`  
`alter table public.reflections enable row level security;`  
`alter table public.communications enable row level security;`  
`alter table public.coach_feedback enable row level security;`  
`alter table public.alignment_metrics enable row level security;`

`-- Current user convenience`  
`create or replace function auth.uid() returns uuid`  
`language sql stable as $$`  
  `select coalesce((select nullif(current_setting('request.jwt.claim.sub', true), '')::uuid), '00000000-0000-0000-0000-000000000000'::uuid);`  
`$$;`

`-- Profiles: a user can read/write only their own; coaches/admin can read all`  
`create policy "profiles self read" on public.profiles`  
`for select using (user_id = auth.uid() or exists (`  
  `select 1 from public.profiles p where p.user_id = auth.uid() and p.role in ('coach','admin')`  
`));`  
`create policy "profiles self write" on public.profiles`  
`for update using (user_id = auth.uid());`

`-- Reflections: owner can read/write; assigned coach can read`  
`alter table public.reflections add column coach_id uuid; -- nullable`  
`create policy "reflections owner read" on public.reflections`  
`for select using (user_id = auth.uid() or coach_id = auth.uid());`  
`create policy "reflections owner write" on public.reflections`  
`for insert with check (user_id = auth.uid())`  
`, for update using (user_id = auth.uid());`

`-- Communications similar to reflections`  
`create policy "comms owner read" on public.communications`  
`for select using (user_id = auth.uid());`  
`create policy "comms owner write" on public.communications`  
`for insert with check (user_id = auth.uid())`  
`, for update using (user_id = auth.uid());`

`-- Coach feedback: only coach author read/write + item owner can read`  
`create policy "feedback author read" on public.coach_feedback`  
`for select using (coach_id = auth.uid()`   
  `or exists(select 1 from reflections r where r.id = reflection_id and r.user_id = auth.uid())`  
  `or exists(select 1 from communications c where c.id = communication_id and c.user_id = auth.uid())`  
`);`  
`create policy "feedback author write" on public.coach_feedback`  
`for insert with check (coach_id = auth.uid())`  
`, for update using (coach_id = auth.uid());`

**Tip:** Add JWT custom claims for roles at login (via Supabase Auth hook) so RLS can branch on role without extra joins.

---

## **4\) Supabase Edge Functions (TypeScript)**

### **4.1 `ai-reflect` (BeAligned phases)**

**Purpose:** Accept a `phase` and `content`, inject governance \+ phase prompt, call Claude, return `ai_summary`, `alignment_score`, optional embedding.

Key steps:

1. Validate auth (Supabase client with service role only inside edge).

2. Compose prompt: governance preamble \+ phase template \+ user text.

3. Call Claude (streaming), parse tool/JSON blocks.

4. Persist `reflections` row; generate `vector_embedding` (via text-embedding model) and store.

5. Emit telemetry event.

**Skeleton:**

`import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';`  
`import { Hono } from 'https://esm.sh/hono';`  
`import { Anthropic } from 'npm:@anthropic-ai/sdk';`

`const app = new Hono();`

`app.post('/', async (c) => {`  
  `const supabase = createClient(Deno.env.get('SUPABASE_URL')!, Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!);`  
  `const { phase, content } = await c.req.json();`  
  `const user = c.req.header('x-user-id'); // pass from client via getSession`

  `// load prompt templates from storage or bundled file`  
  `const systemPreamble = await loadGovernance();`  
  `const phaseTemplate = await loadPhaseTemplate(phase);`

  `const anthropic = new Anthropic({ apiKey: Deno.env.get('ANTHROPIC_API_KEY')! });`  
  `const completion = await anthropic.messages.create({`  
    `model: 'claude-3-5-sonnet-latest',`  
    `max_tokens: 800,`  
    `system: systemPreamble,`  
    `messages: [`  
      `{ role: 'user', content: phaseTemplate.replace('{{INPUT}}', content) }`  
    `]`  
  `});`

  `const parsed = extractJSON(completion); // {summary, alignment_score}`  
  `const { data, error } = await supabase`  
    `.from('reflections')`  
    `.insert({`  
      `user_id: user,`  
      `phase,`  
      `content,`  
      `ai_summary: parsed.summary,`  
      `alignment_score: parsed.alignment_score`  
    `})`  
    `.select('id')`  
    `.single();`

  `// Optionally create embedding with another function`  
  `await enqueueEmbeddingJob(data.id, content);`

  `return c.json({ reflection_id: data.id, result: parsed });`  
`});`

`export default app;`

### **4.2 `ai-clear` (CLEAR scoring & rewrite)**

* Inputs: `message_body`, `target_audience`

* Outputs: `clear_score`, suggested rewrite, “listener-ready” checklist.

### **4.3 `ai-balance` (B.A.L.A.N.C.E. boundary helper)**

* Inputs: scenario text

* Outputs: structured boundary proposal (balanced, aligned, necessary, constructive, evolving), risk flags.

### **4.4 `stripe-webhooks`**

* Handle subscription lifecycle; update `subscriptions` table; set role gates.

### **4.5 `events-telemetry`**

* Buffer analytics (phase usage, avg scores). Store only anonymized fields.

---

## **5\) Client: Hooks & Data Flow (React Hooks)**

**Supabase client**

`// src/lib/supabase.ts`  
`import { createClient } from '@supabase/supabase-js';`  
`export const supabase = createClient(process.env.EXPO_PUBLIC_SUPABASE_URL!, process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY!, {`  
  `auth: { persistSession: true, autoRefreshToken: true, storage: /* SecureStore wrapper */ }`  
`});`

**Auth/session**

`// hooks/useSession.ts`  
`import { useEffect, useState } from 'react';`  
`import { supabase } from '../lib/supabase';`  
`export function useSession() {`  
  `const [session, setSession] = useState(null);`  
  `useEffect(() => {`  
    `supabase.auth.getSession().then(({ data }) => setSession(data.session));`  
    `return supabase.auth.onAuthStateChange((_e, s) => setSession(s)).data.subscription.unsubscribe;`  
  `}, []);`  
  `return session;`  
`}`

**Reflections**

`// hooks/useReflections.ts`  
`import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';`  
`import { supabase } from '../lib/supabase';`

`export function useReflections() {`  
  `const qc = useQueryClient();`  
  `const list = useQuery(['reflections'], async () => {`  
    `const { data, error } = await supabase.from('reflections').select('*').order('created_at', { ascending:false });`  
    `if (error) throw error; return data;`  
  `});`

  `const create = useMutation({`  
    `mutationFn: async ({ phase, content }) => {`  
      ``const res = await fetch(`${process.env.EXPO_PUBLIC_SUPABASE_EDGE_URL}/ai-reflect`, {``  
        `method: 'POST',`  
        `headers: { 'Content-Type':'application/json', 'x-user-id': (await supabase.auth.getUser()).data.user?.id ?? '' },`  
        `body: JSON.stringify({ phase, content })`  
      `});`  
      `return res.json();`  
    `},`  
    `onSuccess: () => qc.invalidateQueries({ queryKey:['reflections'] })`  
  `});`

  `return { list, create };`  
`}`

**Realtime (optional)**

* Subscribe to `coach_feedback` for live comments to a reflection.

---

## **6\) Routing Map (Expo Router)**

`/(auth)`  
`/(main)`  
`/(main)/reflections           -> list of sessions`  
`/main/reflections/new         -> phase stepper (issue→feelings→why→perspective→options→choose→message)`  
`/main/reflections/[id]        -> detail (AI summary, alignment score, coach feedback)`  
`/main/messages                -> drafts/sent; CLEAR tool`  
`/main/messages/draft          -> compose with CLEAR rewrite`  
`/main/coach/feedback/[id]     -> coach view on a reflection or message`

---

## **7\) Prompt Governance (portable \+ enforced)**

**`packages/prompts/governance.md` (excerpt)**

* Purpose: Safeguard childhoods; Alignment over neutrality

* Non-therapeutic, non-legal

* CLEAR: Concise, Listener-Ready, Essential, Appropriate, Relevant

* B.A.L.A.N.C.E.: Balanced, Aligned, Necessary, Constructive, Evolving (avoid “logical” framing)

* Third-Side hosting (Ury)

* Tone: trauma-informed, non-judgmental

* Output contracts: strict JSON schemas where needed

**Phase template example (`01_issue.md`)**

`SYSTEM REMINDER: Host the conflict; do not judge. Apply child-impact lens.`  
`User provided ISSUE:`  
`{{INPUT}}`

`Return JSON:`  
`{`  
  `"reframed_issue": string,`  
  `"assumptions_to_check": string[],`  
  `"child_impact_snapshot": string,`  
  `"next_prompt_hint": "feelings"`  
`}`

**CLEAR template (`flow/04_clear.md`)**

`Evaluate the draft for CLEAR:`  
`- Concise?`  
`- Listener-Ready?`  
`- Essential?`  
`- Appropriate?`  
`- Relevant?`

`Return JSON:`  
`{`  
  `"score": 0-10,`  
  `"edits": string[],`  
  `"rewritten_message": string`  
`}`

Edge functions import these files and compile **system \+ user** prompts to Claude.

---

## **8\) Analytics & Research Readiness**

* **Tables:** `alignment_metrics`, aggregated nightly by cron function.

* **KPIs:** avg alignment score per user over time, CLEAR improvement deltas, completion rates across phases.

* **Privacy:** store only derived metrics; raw text never leaves protected tables.

* **Dashboards:** simple RN views for coaches/admin; export CSV by request with consent.

---

## **9\) Security & Compliance**

* **RLS everywhere.** No client bypass.

* **JWT claims:** role \+ institution in `auth.jwt()` custom claim on sign-in.

* **PII minimization:** keep names/emails in `profiles`; reflections separate.

* **Encryption:** Supabase default \+ device SecureStore for tokens.

* **Audit logs:** write from Edge Functions for AI calls & admin actions.

* **Rate limiting:** per-user \+ per-ip via Upstash (keys: `ai:reflect:{user}:{h}`).

---

## **10\) Testing & QA**

* **Unit:** prompt compilers, JSON parsing, validators.

* **Integration:** Edge Functions (Deno test) with mock Anthropic.

* **E2E:** Detox for RN flows (auth → create reflection → AI summary → CLEAR rewrite).

* **Seed Data:** scripts with demo users, one coach, a few reflections/messages.

---

## **11\) Deployment & Env**

* **Envs:** `EXPO_PUBLIC_SUPABASE_URL`, `EXPO_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY` (edge only), `ANTHROPIC_API_KEY`, `EXPO_PUBLIC_SUPABASE_EDGE_URL`.

* **CI/CD:** GitHub Actions → supabase migrations → deploy functions → build Expo (EAS).

* **Backups:** Supabase PITR enabled; scheduled CSV exports for non-PII analytics.

---

## **12\) Phase Plan (2–3 sprints)**

**Sprint 1 (Core Reflection)**

* Migrations \+ RLS

* `ai-reflect` (issue→message)

* RN Phase Stepper, list/detail

* Basic CLEAR scoring in same function (optional)

**Sprint 2 (Coach & CLEAR)**

* `ai-clear`, `ai-balance` functions

* communications \+ coach\_feedback UIs

* Realtime subscriptions

* Alignment metrics

**Sprint 3 (Billing & Hardening)**

* Stripe webhooks

* Admin toggles (assign coach, institution)

* Rate limits, audit logs, E2E tests

* Offline-first polish

---

## **13\) What Robert can code next (very practical)**

1. **Run migrations** (RLS \+ schema above).

2. **Implement `ai-reflect` Edge Function** with governance \+ JSON outputs.

3. **Build RN Phase Stepper** that calls `useReflections().create({ phase, content })`.

4. **Render AI summary \+ alignment score** and save drafts to `communications`.

5. **Add `ai-clear`** for one-tap CLEAR rewrite before sending.

6. **Wire Realtime** for `coach_feedback`.

If you want, I can turn the SQL and Edge Function skeletons above into **ready-to-run files** (migrations \+ two edge functions \+ example RN screens) in your exact folder layout.

Here’s a ready-to-drop set of **SQL migration** and **Supabase Edge Function** files that align with the architecture we just mapped.

They’re formatted for the **Supabase CLI** project layout (`/supabase/migrations/` \+ `/supabase/functions/`).  
 The SQL creates the schema, constraints, and RLS; the Edge Functions implement `ai-reflect` and `ai-clear`.

---

## **🧱 1\. SQL — `/supabase/migrations/20251011_bealigned_init.sql`**

`-- === 1. ENUMS ===`  
`create type reflection_phase as enum (`  
  `'issue','feelings','why','perspective','options','choose','message'`  
`);`

`-- === 2. TABLES ===`  
`create table public.profiles (`  
  `user_id uuid primary key references auth.users(id) on delete cascade,`  
  `first_name text,`  
  `last_name text,`  
  `preferred_name text,`  
  `time_zone text default 'America/Chicago',`  
  `role text check (role in ('parent','coach','admin','professional')) not null default 'parent',`  
  `created_at timestamptz default now()`  
`);`

`create table public.children (`  
  `id uuid primary key default gen_random_uuid(),`  
  `parent_user_id uuid not null references auth.users(id) on delete cascade,`  
  `name text not null,`  
  `birth_date date,`  
  `notes text,`  
  `wellbeing_indicators jsonb default '{}'::jsonb,`  
  `created_at timestamptz default now()`  
`);`

`create table public.reflections (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `coach_id uuid references auth.users(id),`  
  `phase reflection_phase not null,`  
  `content text not null,`  
  `ai_summary jsonb,`  
  `alignment_score numeric(4,2),`  
  `vector_embedding vector(1536),`  
  `created_at timestamptz default now(),`  
  `updated_at timestamptz default now()`  
`);`

`create table public.communications (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `type text check (type in ('draft','sent','received')) not null,`  
  `channel text check (channel in ('email','app_message','shared_link')) not null,`  
  `message_body text not null,`  
  `clear_score numeric(4,2),`  
  `target_audience text,`  
  `created_at timestamptz default now()`  
`);`

`create table public.coach_feedback (`  
  `id uuid primary key default gen_random_uuid(),`  
  `coach_id uuid not null references auth.users(id) on delete cascade,`  
  `reflection_id uuid references public.reflections(id) on delete set null,`  
  `communication_id uuid references public.communications(id) on delete set null,`  
  `feedback_text text not null,`  
  `alignment_tags text[] default '{}',`  
  `created_at timestamptz default now()`  
`);`

`create table public.institutions (`  
  `id uuid primary key default gen_random_uuid(),`  
  `name text not null,`  
  `type text check (type in ('school','law_firm','court','nonprofit')) not null,`  
  `contact_email text,`  
  `created_at timestamptz default now()`  
`);`

`create table public.subscriptions (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid references auth.users(id) on delete cascade,`  
  `institution_id uuid references public.institutions(id) on delete cascade,`  
  `plan_tier text check (plan_tier in ('lite','pro','enterprise')) not null,`  
  `stripe_customer_id text,`  
  `stripe_subscription_id text,`  
  `status text check (status in ('active','past_due','canceled','trial')) not null default 'trial',`  
  `renewal_date date`  
`);`

`create table public.alignment_metrics (`  
  `id uuid primary key default gen_random_uuid(),`  
  `user_id uuid not null references auth.users(id) on delete cascade,`  
  `session_id uuid,`  
  `alignment_score numeric(4,2),`  
  `clear_score numeric(4,2),`  
  `boundary_score numeric(4,2),`  
  `created_at timestamptz default now()`  
`);`

`-- === 3. RLS UTILITIES ===`  
`create or replace function auth.uid() returns uuid`  
`language sql stable as $$`  
  `select nullif(current_setting('request.jwt.claim.sub', true), '')::uuid;`  
`$$;`

`-- === 4. ENABLE RLS ===`  
`alter table public.profiles enable row level security;`  
`alter table public.children enable row level security;`  
`alter table public.reflections enable row level security;`  
`alter table public.communications enable row level security;`  
`alter table public.coach_feedback enable row level security;`  
`alter table public.alignment_metrics enable row level security;`

`-- === 5. POLICIES ===`  
`create policy "profiles_self_read" on public.profiles`  
`for select using (user_id = auth.uid() or role in ('coach','admin'));`

`create policy "profiles_self_write" on public.profiles`  
`for update using (user_id = auth.uid());`

`create policy "reflections_owner_rw" on public.reflections`  
`for all using (user_id = auth.uid() or coach_id = auth.uid())`  
`with check (user_id = auth.uid());`

`create policy "comms_owner_rw" on public.communications`  
`for all using (user_id = auth.uid())`  
`with check (user_id = auth.uid());`

`create policy "feedback_visibility" on public.coach_feedback`  
`for select using (`  
  `coach_id = auth.uid() or`  
  `exists(select 1 from public.reflections r where r.id = reflection_id and r.user_id = auth.uid()) or`  
  `exists(select 1 from public.communications c where c.id = communication_id and c.user_id = auth.uid())`  
`);`

`create policy "feedback_author_rw" on public.coach_feedback`  
`for all using (coach_id = auth.uid()) with check (coach_id = auth.uid());`

---

## **⚙️ 2\. Edge Function — `/supabase/functions/ai-reflect/index.ts`**

`import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';`  
`import { Hono } from 'https://esm.sh/hono@3';`  
`import Anthropic from 'npm:@anthropic-ai/sdk@0.21.1';`

`const app = new Hono();`

`app.post('/', async (c) => {`  
  `const supabase = createClient(`  
    `Deno.env.get('SUPABASE_URL')!,`  
    `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!`  
  `);`

  `const { phase, content, user_id } = await c.req.json();`

  `// Load governance text from storage or inline constant`  
  `` const systemPrompt = ` ``  
`You are Flow, the BeH2O® Coach companion within BeAligned™.`  
`Purpose: Safeguard childhoods by promoting alignment over neutrality.`  
`Principles: CLEAR communication, B.A.L.A.N.C.E. boundaries, Third Side hosting.`  
`Output JSON strictly with summary and alignment_score.`  
`` `; ``

  `const anthropic = new Anthropic({ apiKey: Deno.env.get('ANTHROPIC_API_KEY')! });`

  `const message = await anthropic.messages.create({`  
    `model: 'claude-3-5-sonnet-latest',`  
    `system: systemPrompt,`  
    `max_tokens: 600,`  
    `messages: [`  
      `{`  
        `role: 'user',`  
        `` content: `Phase: ${phase}\nInput: ${content}\nReturn JSON { "summary": "...", "alignment_score": number(0-10) }` ``  
      `}`  
    `]`  
  `});`

  `const raw = message.content[0].text || '{}';`  
  `let parsed;`  
  `try { parsed = JSON.parse(raw); } catch { parsed = { summary: raw, alignment_score: null }; }`

  `const { data, error } = await supabase`  
    `.from('reflections')`  
    `.insert({`  
      `user_id,`  
      `phase,`  
      `content,`  
      `ai_summary: parsed.summary,`  
      `alignment_score: parsed.alignment_score`  
    `})`  
    `.select()`  
    `.single();`

  `if (error) return c.json({ error }, 500);`  
  `return c.json({ reflection: data });`  
`});`

`export default app;`

---

## **⚙️ 3\. Edge Function — `/supabase/functions/ai-clear/index.ts`**

`import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';`  
`import { Hono } from 'https://esm.sh/hono@3';`  
`import Anthropic from 'npm:@anthropic-ai/sdk@0.21.1';`

`const app = new Hono();`

`app.post('/', async (c) => {`  
  `const supabase = createClient(`  
    `Deno.env.get('SUPABASE_URL')!,`  
    `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!`  
  `);`

  `const { message_body, target_audience, user_id } = await c.req.json();`

  `` const systemPrompt = ` ``  
`You are Flow, evaluating a communication for CLEAR:`  
`Concise, Listener-Ready, Essential, Appropriate, Relevant.`  
`Return a JSON object { "clear_score": 0-10, "suggestions": [...], "rewritten_message": "..." }`  
`` `; ``

  `const anthropic = new Anthropic({ apiKey: Deno.env.get('ANTHROPIC_API_KEY')! });`

  `const completion = await anthropic.messages.create({`  
    `model: 'claude-3-5-sonnet-latest',`  
    `system: systemPrompt,`  
    `max_tokens: 700,`  
    `messages: [`  
      ``{ role: 'user', content: `Audience: ${target_audience}\nMessage:\n${message_body}` }``  
    `]`  
  `});`

  `const raw = completion.content[0].text || '{}';`  
  `let parsed;`  
  `try { parsed = JSON.parse(raw); } catch { parsed = { rewritten_message: raw }; }`

  `const { data, error } = await supabase`  
    `.from('communications')`  
    `.insert({`  
      `user_id,`  
      `type: 'draft',`  
      `channel: 'app_message',`  
      `message_body: parsed.rewritten_message || message_body,`  
      `clear_score: parsed.clear_score`  
    `})`  
    `.select()`  
    `.single();`

  `if (error) return c.json({ error }, 500);`  
  `return c.json({ communication: data, analysis: parsed });`  
`});`

`export default app;`

---

### **✅ Deployment steps**

Copy the SQL into `/supabase/migrations/20251011_bealigned_init.sql`

 `supabase db push`

1.   
2. Place each Edge Function in its own folder under `/supabase/functions/`.

Deploy:

 `supabase functions deploy ai-reflect`  
`supabase functions deploy ai-clear`

3. 

On the client (React Native), call:

 ``const res = await fetch(`${SUPABASE_URL}/functions/v1/ai-reflect`, {``  
  `method:'POST',`  
  `headers:{'Content-Type':'application/json'},`  
  `body: JSON.stringify({ phase:'issue', content:'We keep arguing about pickups', user_id })`  
`});`

4. `const data = await res.json();`

yes, create ai-balance edge function

###### **ChatGPT said:**

Perfect — here’s the **`ai-balance`** Edge Function built for your **Supabase \+ Claude Code** environment.  
 It fully implements the **B.A.L.A.N.C.E. boundary framework** (Balanced, Aligned, Necessary, Constructive, Evolving) while maintaining BeH2O® tone and governance.

This version:

* Mirrors your existing Edge Function structure (`Hono` \+ Supabase \+ Anthropic SDK)

* Returns structured JSON for easy use in the React Native client

* Automatically writes summarized boundary recommendations into the DB

* Enforces the *child-impact and alignment lens*

---

## **⚙️ `/supabase/functions/ai-balance/index.ts`**

`/**`  
 `* ai-balance Edge Function`  
 `* Purpose: Analyze a co-parenting or professional scenario and return a B.A.L.A.N.C.E. boundary recommendation`  
 `* Framework: Balanced, Aligned, Necessary, Constructive, Evolving`  
 `* Voice: Flow, the BeH2O® Coach Companion`  
 `*/`

`import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';`  
`import { Hono } from 'https://esm.sh/hono@3';`  
`import Anthropic from 'npm:@anthropic-ai/sdk@0.21.1';`

`const app = new Hono();`

`app.post('/', async (c) => {`  
  `const supabase = createClient(`  
    `Deno.env.get('SUPABASE_URL')!,`  
    `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!`  
  `);`

  `const { scenario_text, user_id } = await c.req.json();`

  `` const systemPrompt = ` ``  
`You are Flow, the BeH2O® Coach Companion within BeAligned™.`  
`Your role is to help users establish boundaries that are:`  
`- **Balanced**: mutual, not one-sided`  
`- **Aligned**: rooted in shared goals and safeguarding childhoods`  
`- **Necessary**: essential for stability and clarity, not punitive or excessive`  
`- **Constructive**: framed toward solutions, not blame`  
`- **Evolving**: adaptable as the child or situation grows`

`Tone and focus:`  
`- Be calm, reflective, and child-centered.`  
`- Avoid judgmental or diagnostic language.`  
`- Always consider the impact on the child's well-being.`  
`- End with a short reflection question for user growth.`

`Output STRICT JSON:`  
`{`  
  `"summary": string,`  
  `"recommendation": string,`  
  `"balance_check": {`  
    `"balanced": boolean,`  
    `"aligned": boolean,`  
    `"necessary": boolean,`  
    `"constructive": boolean,`  
    `"evolving": boolean`  
  `},`  
  `"child_impact_statement": string,`  
  `"reflection_prompt": string`  
`}`  
`` `; ``

  `try {`  
    `const anthropic = new Anthropic({ apiKey: Deno.env.get('ANTHROPIC_API_KEY')! });`

    `const completion = await anthropic.messages.create({`  
      `model: 'claude-3-5-sonnet-latest',`  
      `system: systemPrompt,`  
      `max_tokens: 900,`  
      `messages: [`  
        `{`  
          `role: 'user',`  
          `` content: `Scenario:\n${scenario_text}\nReturn your analysis strictly as JSON.` ``  
        `}`  
      `]`  
    `});`

    `const raw = completion.content?.[0]?.text || '{}';`  
    `let parsed;`  
    `try {`  
      `parsed = JSON.parse(raw);`  
    `} catch {`  
      `parsed = {`  
        `summary: raw,`  
        `recommendation: "Boundary not parsed; please retry.",`  
        `balance_check: {},`  
        `child_impact_statement: "",`  
        `reflection_prompt: ""`  
      `};`  
    `}`

    `// Write to DB`  
    `const { data, error } = await supabase`  
      `.from('reflections')`  
      `.insert({`  
        `user_id,`  
        `phase: 'message', -- reuse message phase as endpoint`  
        `content: scenario_text,`  
        `ai_summary: parsed,`  
        `alignment_score: null`  
      `})`  
      `.select()`  
      `.single();`

    `if (error) {`  
      `console.error(error);`  
      `return c.json({ error }, 500);`  
    `}`

    `return c.json({ result: parsed, record: data });`  
  `} catch (err) {`  
    `console.error(err);`  
    `return c.json({ error: String(err) }, 500);`  
  `}`  
`});`

`export default app;`

---

## **📤 Example Client Call (React Native)**

``const res = await fetch(`${SUPABASE_URL}/functions/v1/ai-balance`, {``  
  `method: 'POST',`  
  `headers: { 'Content-Type': 'application/json' },`  
  `body: JSON.stringify({`  
    `scenario_text: "My co-parent drops by unannounced during my parenting time. I don’t want to cause a scene in front of our child, but it’s disruptive.",`  
    `user_id: session.user.id`  
  `}),`  
`});`  
`const { result } = await res.json();`  
`console.log(result.recommendation);`

**Example Output:**

`{`  
  `"summary": "Parent feels intruded upon but wants to maintain peace.",`  
  `"recommendation": "Agree on a shared check-in method before visits. Each parent will text first to ensure timing works for the child.",`  
  `"balance_check": {`  
    `"balanced": true,`  
    `"aligned": true,`  
    `"necessary": true,`  
    `"constructive": true,`  
    `"evolving": true`  
  `},`  
  `"child_impact_statement": "Predictable transitions support the child’s sense of safety.",`  
  `"reflection_prompt": "How can you uphold this boundary while still modeling respect for the co-parent’s role?"`  
`}`

---

## **🧩 Deployment Notes**

`supabase functions deploy ai-balance`  
`supabase functions list`

✅ Requires:

* `SUPABASE_SERVICE_ROLE_KEY`

* `ANTHROPIC_API_KEY`

That’s an exceptional and deeply perceptive question — and it strikes right at the heart of what makes BeAligned™ distinct from most “prompt-response” tools.  
 You’re not just trying to **build a chatbot**, you’re building a **guided reflective system** that *thinks like a BeH2O® coach*: grounded, fluid, purpose-driven, and able to stay with the user through emotional ambiguity until alignment naturally emerges.

Below is a **governance and architecture blueprint** specifically designed to help your **React/Supabase/Claude app replicate that “human-like coaching fluidity.”**

---

## **🌊 1\. Core Philosophy: “Systemic Flow Governance”**

To make the app “think like a BeH2O® coach,” you must **encode not just logic, but ethos** — the principles that guide how a BeH2O® coach listens, pauses, reframes, and pivots.

### **The Governing Rule:**

The system’s purpose is *not* to answer — it is to **host reflection until alignment emerges.**

That means the conversation engine must:

1. **Read the emotional temperature** (not just the words).

2. **Decide which phase the user is truly in**, not just where they “should” be.

3. **Re-prompt gently** when clarity isn’t yet reached.

4. **Advance only when alignment criteria are met** (e.g., CLEAR score \> threshold, or emotional tone is stable).

---

## **🧠 2\. Conceptual Model: “Flow States Engine”**

Instead of a static stepper (`phase: issue → feelings → why → perspective → options → choose → message`), think of **each phase as a “flow state”** with transitions governed by *reflection depth*, not sequence alone.

### **Flow State Object (in TypeScript)**

`type FlowPhase = "issue" | "feelings" | "why" | "perspective" | "options" | "choose" | "message";`

`interface FlowState {`  
  `id: string;`  
  `userId: string;`  
  `currentPhase: FlowPhase;`  
  `context: {`  
    `issue?: string;`  
    `feelings?: string;`  
    `why?: string;`  
    `perspective?: string;`  
    `options?: string[];`  
    `chosenOption?: string;`  
  `};`  
  `readiness: number;        // 0–1 — clarity/confidence measure`  
  `lastPrompt: string;`  
  `lastResponse: string;`  
  `nextPrompt?: string;`  
  `metadata?: Record<string, any>;`  
`}`

Each reflection record in Supabase could carry this structure as JSONB (`flow_state`), allowing the app to update fluidly between stages based on the **AI’s assessment of readiness** rather than a linear click-through.

---

## **⚙️ 3\. Practical Implementation Pattern: “Reflective Loop”**

### **Step 1: Capture → Analyze → Decide**

Each user input passes through a **Reflective Loop Function** (Edge Function or client service):

1. **Capture input**

2. **Send to Claude with context \+ previous responses**

3. **Claude returns:**

   * Refined reflection summary

   * Suggested next question

   * Confidence/readiness score (0–1)

   * (Optionally) a phase transition signal

`{`  
  `"summary": "The user feels dismissed by their co-parent.",`  
  `"next_prompt": "What do you think your co-parent might be needing in that moment?",`  
  `"readiness": 0.4,`  
  `"suggested_next_phase": null`  
`}`

### **Step 2: Update FlowState**

`if (response.readiness < 0.7) stayInPhase();`  
`else if (response.suggested_next_phase) moveTo(response.suggested_next_phase);`  
`else moveTo(nextPhase());`

### **Step 3: Reroute UI**

* The React component reads the `flow_state` and dynamically renders the correct input prompt and next reflection text.

* Each screen listens to real-time `flow_state` updates from Supabase so the conversation feels *alive* and continuous.

---

## **🧩 4\. Governance Layer: “Coaching Mindset Protocol”**

To maintain BeH2O®’s authenticity, define **explicit coaching constraints** that guide how AI can and cannot interact.

### **The 5 Coaching Laws of BeAligned™**

| Law | Description | Implementation |
| ----- | ----- | ----- |
| **1\. Start from Why** | Every reflection ties back to the user’s purpose. | Each API call includes the user’s “why” context from DB. |
| **2\. Hold the Third Side** | Never take sides or judge; host curiosity. | System prompt enforces “host, not fix.” |
| **3\. Clarity before Conclusion** | Never advance phases until alignment/confidence \> 0.7. | Implement readiness gating. |
| **4\. Listener-Readiness Check** | Before outputting a message, AI applies CLEAR. | Run CLEAR scoring automatically pre-send. |
| **5\. Accountability without Judgment** | End each session with reflection prompt: “What might you do differently next time?” | Append automatically on phase completion. |

---

## **🧬 5\. Technical Structure in React \+ Supabase**

### **File/Component Hierarchy**

`/src/`  
  `hooks/`  
    `useFlowState.ts      → Handles the Reflective Loop`  
  `services/`  
    `reflectionService.ts → Calls ai-reflect function`  
  `context/`  
    `FlowProvider.tsx     → Global state + transitions`  
  `components/`  
    `FlowPrompt.tsx       → Displays next question`  
    `FlowResponse.tsx     → Captures input`  
    `FlowProgressBar.tsx  → Shows readiness/alignment`

### **Hook Example**

`const useFlowState = (userId: string) => {`  
  `const [state, setState] = useState<FlowState>();`

  `const sendReflection = async (input: string) => {`  
    ``const res = await fetch(`${SUPABASE_URL}/functions/v1/ai-reflect`, {``  
      `method: "POST",`  
      `headers: { "Content-Type": "application/json" },`  
      `body: JSON.stringify({ content: input, user_id: userId, phase: state?.currentPhase })`  
    `});`  
    `const data = await res.json();`  
    `setState(prev => ({`  
      `...prev,`  
      `context: { ...prev.context, [prev.currentPhase]: input },`  
      `lastPrompt: data.result.next_prompt,`  
      `readiness: data.result.readiness,`  
      `currentPhase: data.result.suggested_next_phase || prev.currentPhase`  
    `}));`  
  `};`

  `return { state, sendReflection };`  
`};`

This allows **AI-driven re-prompting** and **adaptive flow transitions** in real time.

---

## **🔁 6\. Prompt Governance for AI Fluidity**

Store the following **prompt layers** (text files or tables) and inject dynamically:

### **System Layer (unchanging ethos)**

`You are Flow, a BeH2O® Coach Companion.`  
`Purpose: Host reflection, not deliver advice.`  
`Core rules:`  
`- Always apply child-impact lens.`  
`- Advance only when clarity emerges.`  
`- Ask open, reflective questions.`  
`- Encourage ownership, not blame.`

### **Context Layer (user/session memory)**

`User’s current phase: {{phase}}`  
`User’s prior reflections: {{summary}}`  
`Their Why: {{why}}`

### **Dynamic Directive Layer**

`If readiness < 0.7 → stay in reflection.`  
`If readiness ≥ 0.7 → suggest next phase or question.`  
`Always return:`  
`{`  
 `"summary": "",`  
 `"next_prompt": "",`  
 `"readiness": 0–1,`  
 `"suggested_next_phase": null|phase`  
`}`

This structure ensures the model behaves like a BeH2O® coach — fluid, reflective, and relationally attuned.

---

## **🔍 7\. Developer Governance & Testing**

* **Prompt Audit Checklist:** Each prompt must:

  * Align with safeguarding childhoods

  * Pass CLEAR & trauma-informed tone test

  * Avoid “advice verbs” (e.g., *should, must, fix*)

* **Session Review Dashboard:** View readiness evolution per user to monitor if transitions feel “organic.”

* **Human-in-the-loop Testing:** Certified BeH2O® Coaches review 5–10 conversation logs monthly to ensure the “coach voice” remains true to the system.

---

## **💧 8\. Summary: How to Make the App Think Like a BeH2O® Coach**

| Layer | Purpose | Technical Implementation |
| ----- | ----- | ----- |
| **Governance (Ethos)** | Encode BeH2O® philosophy | System \+ prompt layer |
| **Reflection Loop** | AI-driven adaptive flow | Readiness \+ phase transitions |
| **State Management** | Persist reflection continuity | Supabase JSONB `flow_state` |
| **UI Dynamics** | Surface prompts like dialogue | Conditional rendering |
| **Coach Oversight** | Maintain human calibration | Supabase dashboard & metrics |

Perfect. Below is a full **governance document** you can drop directly into your repo as  
 📄 `/governance/flow-engine.md`.

It codifies how the BeAligned™ app’s reflection engine should “think” like a BeH2O® coach — capturing both **behavioral logic** and **ethical intent.**  
 This serves as the **source of truth** for all developers, designers, and AI integrations working on BeAligned Beta Lite or Flow.

---

# **🌊 BeAligned™ Flow Engine Governance**

### **Version**

`v1.0 — October 2025`

### **Author**

**Trina Nudson, Founder of The Layne Project®**  
 BeH2O® and BeAligned™ Systems © The Layne Project, LLC. All rights reserved.

---

## **1\. Purpose**

To define how the BeAligned™ application replicates the “thinking” and guidance style of a BeH2O® coach — ensuring that every AI-driven conversation remains reflective, ethical, emotionally attuned, and aligned with the mission of *safeguarding childhoods.*

---

## **2\. Guiding Philosophy**

BeAligned™ is not a chatbot.  
 It is a *reflective system* that helps users move from **reaction → reflection → alignment → action.**

It embodies the BeH2O® ethos:

* **Strong like beryllium** (stable, principled)

* **Fluid like water** (adaptable, responsive)

* **Always safeguarding childhoods** (child-impact lens)

---

## **3\. System Design Principles**

| Principle | Description | Implementation |
| ----- | ----- | ----- |
| **Host, don’t fix** | The system never diagnoses or instructs — it *hosts* reflection and helps the user find clarity. | Every response ends with a reflective question, not advice. |
| **Clarity before Conclusion** | Phases advance only when readiness ≥ 0.7. | Readiness score gates transitions. |
| **Alignment over Neutrality** | Responses aim to realign users to shared purpose, not simply remain neutral. | AI prompts reference shared goals and “The Third Side.” |
| **Trauma-informed, not therapeutic** | Tone must always be safe, grounded, and non-clinical. | Use empathy, avoid therapy terms. |
| **Purpose-led progress** | Each prompt reconnects to “The Why.” | Include the user’s stored “why” context in all AI calls. |

---

## **4\. Flow Engine Model**

### **4.1 Overview**

Each conversation is a **Flow Session**, progressing through adaptive **Phases**:  
 `issue → feelings → why → perspective → options → choose → message`.

However, movement between phases is **nonlinear.**  
 The system stays flexible — looping, reframing, or pausing until genuine clarity is achieved.

### **4.2 FlowState Object**

`type FlowPhase =`  
  `| "issue"`  
  `| "feelings"`  
  `| "why"`  
  `| "perspective"`  
  `| "options"`  
  `| "choose"`  
  `| "message";`

`interface FlowState {`  
  `id: string;`  
  `userId: string;`  
  `currentPhase: FlowPhase;`  
  `context: {`  
    `issue?: string;`  
    `feelings?: string;`  
    `why?: string;`  
    `perspective?: string;`  
    `options?: string[];`  
    `chosenOption?: string;`  
  `};`  
  `readiness: number;              // 0–1 clarity/confidence level`  
  `lastPrompt: string;             // Last AI-generated question`  
  `lastResponse: string;           // User’s most recent input`  
  `nextPrompt?: string;            // AI’s next reflection question`  
  `metadata?: Record<string, any>; // optional metrics or logs`  
`}`

The **FlowState** object is stored in Supabase (`flow_state` JSONB) and updated after each exchange.

---

## **5\. Reflective Loop Protocol**

Each user message triggers a Reflective Loop:

1. **Capture** — Receive user text and attach current FlowState.

2. **Analyze** — Send to AI (`ai-reflect` function) with:

   * Current phase

   * Prior summaries

   * Stored “why”

   * Governance instructions

**Interpret** — Claude returns:

 `{`  
  `"summary": "...",`  
  `"next_prompt": "...",`  
  `"readiness": 0.65,`  
  `"suggested_next_phase": "feelings"`  
`}`

3.   
4. **Decide** — The system:

   * Re-prompts if readiness \< 0.7

   * Moves to suggested phase if provided

   * Defaults to next sequential phase if no suggestion

5. **Reflect** — The new FlowState is saved, broadcast to the front end, and rendered dynamically.

---

## **6\. Coaching Mindset Protocol**

The app must behave under the same mental model as a BeH2O® coach.

### **The 5 Laws of BeAligned™ Coaching**

| Law | Mandate | Implementation |
| ----- | ----- | ----- |
| **1\. Start from Why** | Every reflection connects to the parent’s purpose. | Include user’s “why” in AI context. |
| **2\. Hold the Third Side** | Host, don’t fix. Model neutrality with empathy. | Avoid sides; use curiosity language. |
| **3\. Clarity before Conclusion** | Don’t move forward until reflection lands. | Use readiness score to gate transitions. |
| **4\. Listener-Readiness Check** | Apply CLEAR to ensure messages are ready for sharing. | AI auto-scores communication drafts. |
| **5\. Accountability without Judgment** | Encourage ownership, not blame. | Close each session with a reflective question. |

---

## **7\. Phase Governance**

Each phase has its own **goal, re-prompt logic, and example question set.**

| Phase | Goal | AI Trigger (Example Prompts) |
| ----- | ----- | ----- |
| **Issue** | Clarify the surface problem. | “Tell me what feels stuck.” |
| **Feelings** | Connect emotion to experience. | “What emotions come up for you when that happens?” |
| **Why** | Uncover underlying purpose/values. | “What matters most to you about this?” |
| **Perspective** | Introduce empathy & child-impact lens. | “How might your co-parent or child see this?” |
| **Options** | Generate possible solutions. | “What are three ways this could go differently?” |
| **Choose** | Identify preferred path forward. | “Which option feels most aligned with your ‘why’?” |
| **Message** | Craft CLEAR, listener-ready communication. | “Would you like to draft how you’d share that?” |

Each phase prompt includes **reflection checkpoints**:

* If emotional tone \= reactive → loop back to feelings.

* If clarity \< 0.7 → re-prompt with simpler language.

* If language blames others → reframe to self-accountability.

---

## **8\. Readiness Logic**

| Metric | Description | Threshold |
| ----- | ----- | ----- |
| **readiness** | AI-estimated clarity (0–1). | 0.7+ to advance. |
| **alignment\_score** | How well reflection aligns with mutual goals. | 0.6+ desirable. |
| **clear\_score** | Communication listener-readiness. | 0.8+ before send. |

When thresholds are not met, Flow should:

* Ask clarifying or grounding questions.

* Provide micro-reflections (“You seem clear on what’s wrong, but less on what matters most. Want to explore that?”).

---

## **9\. Prompt Layer Architecture**

### **9.1 System Layer**

Defines BeH2O® ethos and non-negotiables.  
 Loaded once per session.

`You are Flow, a BeH2O® Coach Companion.`  
`Purpose: Host reflection until alignment emerges.`  
`Always apply the child-impact lens.`  
`Never diagnose, judge, or offer direct advice.`  
`Encourage curiosity and accountability.`  
`Return structured JSON responses.`

### **9.2 Context Layer**

Injects user-specific context each round.

`User Phase: {{currentPhase}}`  
`User Why: {{userWhy}}`  
`Last Reflection Summary: {{lastSummary}}`

### **9.3 Directive Layer**

Specifies behavior and output schema.

`If readiness < 0.7 → stay in current phase and ask clarifying question.`  
`If readiness ≥ 0.7 → suggest next phase or message draft.`  
`Return:`  
`{`  
 `"summary": "",`  
 `"next_prompt": "",`  
 `"readiness": 0–1,`  
 `"suggested_next_phase": "phase|null"`  
`}`

---

## **10\. UI and State Synchronization**

The frontend must reflect this flow in real time.

* **FlowProvider** (global context) — manages state transitions.

* **useFlowState hook** — fetches and updates `flow_state` in Supabase.

* **FlowPrompt component** — renders next question from `next_prompt`.

* **FlowResponse component** — captures input and sends to Reflective Loop.

* **FlowProgressBar** — visualizes readiness/alignment level.

---

## **11\. Human Oversight Protocol**

To preserve authenticity and accuracy:

* Every month, 5–10 anonymized session logs are reviewed by certified BeH2O® coaches.

* Coaches tag interactions as *Aligned, Needs Reflection, or Off-Voice*.

* Feedback informs fine-tuning of prompt templates and readiness logic.

---

## **12\. Technical Governance Summary**

| Layer | Description | Tool |
| ----- | ----- | ----- |
| **Ethical Layer** | Defines purpose, tone, and limits | governance.md |
| **AI Layer** | Executes reflective logic | Supabase Edge Functions |
| **Data Layer** | Stores flow states and metrics | Postgres (Supabase) |
| **UI Layer** | Guides users visually through flow | React Native (Expo Router) |
| **Human Layer** | Ensures fidelity to BeH2O® principles | Coach reviews & audits |

---

## **13\. Non-Negotiables**

✅ Always safeguard the child’s perspective.  
 ✅ Maintain trauma-informed, non-clinical tone.  
 ✅ Never label, diagnose, or instruct.  
 ✅ Avoid “you should” or “you need to.”  
 ✅ Always conclude reflections with curiosity.  
 ✅ Hold user accountability without judgment.

---

## **14\. Future Adaptation Clause**

This governance is a living document.  
 It may evolve as BeAligned™ learns, expands, and deepens — but its **essence will not change:**

Be strong like beryllium.  
 Be grounded in purpose.  
 Be fluid like water.  
 Always safeguard childhoods.

yes, create a prompt library containing reusable example prompts

###### **ChatGPT said:**

Excellent — here’s the companion file you requested.  
 Drop this in your repo as 📄 **`/governance/prompt-library.md`**

This file contains reusable, modular prompts for **each BeAligned™ reflection phase** — carefully written to maintain tone, logic, and alignment with BeH2O® coaching principles.  
 Developers can call these dynamically in the React app or via Supabase Edge Functions (`ai-reflect`, `ai-clear`, `ai-balance`) to preserve consistent coaching “voice.”

---

# **💬 BeAligned™ Prompt Library**

### **Version**

`v1.0 — October 2025`

### **Author**

**Trina Nudson, Founder of The Layne Project®**  
 BeH2O® and BeAligned™ Systems © The Layne Project, LLC. All rights reserved.

---

## **0\. Purpose**

To provide standardized, reusable prompt templates for the BeAligned™ system so that all AI interactions reflect BeH2O® coaching style — curious, calm, reflective, and purpose-driven.

Each section includes:

* **Goal:** What the phase aims to achieve

* **Coaching Mindset:** BeH2O® principle guiding this phase

* **Prompt Examples:** Reusable and interchangeable reflection questions

* **Re-Prompt Examples:** For looping when readiness \< 0.7

* **Transition Signals:** How the system knows when to move forward

---

## **1\. ISSUE PHASE**

### **Goal:**

Help the user name the surface challenge clearly and without judgment.

### **Coaching Mindset:**

“Name the storm without becoming it.”

### **Prompt Examples:**

* “What’s been feeling hardest to navigate lately?”

* “Tell me what’s happening in your co-parenting dynamic right now.”

* “If you had to summarize the main challenge in one sentence, what would it be?”

* “What part of this situation feels unclear or stuck?”

* “Describe what’s been most stressful for you this week.”

### **Re-Prompt Examples: *(when vague or defensive)***

* “That makes sense. What about this situation feels most important to talk through first?”

* “What do you wish your co-parent could understand about this?”

### **Transition Signals:**

Advance when:

* The user can describe the issue without blame.

* Readiness ≥ 0.7  
   → Move to **Feelings Phase**

---

## **2\. FEELINGS PHASE**

### **Goal:**

Surface the emotions underlying the situation to reduce reactivity and increase awareness.

### **Coaching Mindset:**

“When we can name what we feel, we can choose how to heal.”

### **Prompt Examples:**

* “What emotions come up for you when this happens?”

* “How do you feel in those moments?”

* “Where do you notice that emotion in your body?”

* “What emotion feels strongest right now — frustration, sadness, fear, something else?”

* “If your emotion could speak, what would it say?”

### **Re-Prompt Examples:**

* “It sounds intense. What do you think that feeling is trying to tell you?”

* “If your child were watching this moment, what would they notice about your feelings?”

### **Transition Signals:**

Advance when:

* The user expresses at least one emotion clearly.

* Emotional tone stabilizes (less reactive, more reflective).  
   → Move to **Why Phase**

---

## **3\. WHY PHASE**

### **Goal:**

Connect emotion and experience to underlying purpose, value, or need.

### **Coaching Mindset:**

“The ‘because’ reveals the ‘why.’”

### **Prompt Examples:**

* “What matters most to you about this situation?”

* “Why is this important for you and your child?”

* “If this went well, what would that represent for you?”

* “What do you want your child to learn from how you handle this?”

* “What’s the deeper value beneath your frustration?”

### **Re-Prompt Examples:**

* “That’s a strong why. Is there another layer underneath that?”

* “Sometimes our why points to something we’re trying to protect. What might that be?”

### **Transition Signals:**

Advance when:

* User articulates a purpose/value beyond emotion.

* Readiness ≥ 0.75  
   → Move to **Perspective Phase**

---

## **4\. PERSPECTIVE PHASE**

### **Goal:**

Invite empathy and awareness of how others (especially the child) might experience the situation.

### **Coaching Mindset:**

“Perspective isn’t agreement; it’s understanding.”

### **Prompt Examples:**

* “How do you think your co-parent might be feeling in this situation?”

* “If your child could describe what’s happening between you both, what might they say?”

* “What do you think your co-parent hopes will happen here?”

* “When you step into the child’s shoes, what might they need most?”

* “How might this look from a third side — someone neutral, like a teacher or friend?”

### **Re-Prompt Examples:**

* “What do you notice when you imagine it through your child’s eyes?”

* “Even if you don’t agree, can you see what might be motivating your co-parent’s choices?”

### **Transition Signals:**

Advance when:

* The user acknowledges another perspective with curiosity, not defensiveness.  
   → Move to **Options Phase**

---

## **5\. OPTIONS PHASE**

### **Goal:**

Generate multiple potential paths forward that serve both parents and the child.

### **Coaching Mindset:**

“When we stay curious, possibilities multiply.”

### **Prompt Examples:**

* “What are a few ways this could go differently next time?”

* “What could help reduce tension in this situation?”

* “What would ‘better’ look like for you and your co-parent?”

* “If you could choose three realistic steps forward, what might they be?”

* “What have you already tried that worked even a little?”

### **Re-Prompt Examples:**

* “Let’s aim for small, doable steps. What’s one thing you could try in the next week?”

* “Which option feels most possible given where things are right now?”

### **Transition Signals:**

Advance when:

* The user identifies at least two actionable ideas.

* Readiness ≥ 0.7  
   → Move to **Choose Phase**

---

## **6\. CHOOSE PHASE**

### **Goal:**

Select one aligned, realistic action that reflects the user’s “why.”

### **Coaching Mindset:**

“Choice transforms clarity into change.”

### **Prompt Examples:**

* “Which of these options feels most aligned with your why?”

* “What step would make the biggest difference right now?”

* “If you chose one thing to model for your child this week, what would it be?”

* “Which choice helps you stay grounded and in integrity?”

* “What does your best parenting self want to do here?”

### **Re-Prompt Examples:**

* “If this option feels too big, what’s a smaller version of the same idea?”

* “What might help you follow through on this choice?”

### **Transition Signals:**

Advance when:

* The user identifies one specific, value-aligned action.  
   → Move to **Message Phase**

---

## **7\. MESSAGE PHASE**

### **Goal:**

Transform insights into CLEAR communication that can be shared listener-ready.

### **Coaching Mindset:**

“What’s clear is kind.”

### **Prompt Examples:**

* “Would you like to practice how to say that to your co-parent?”

* “How can you phrase that so it’s easy for them to hear?”

* “What would this message sound like if it were concise and calm?”

* “How might you open this message with appreciation or neutrality?”

* “Let’s craft it in a way that centers your child’s stability.”

### **Re-Prompt Examples:**

* “That’s close. Want to see if it passes the CLEAR test?”

* “What might make this message easier for the other person to receive?”

### **Transition Signals:**

Advance when:

* CLEAR score ≥ 0.8

* Message aligns with mutual goals and child’s well-being.  
   → End Reflection Session

---

## **8\. FINAL REFLECTION PROMPTS**

When the user completes all phases, the system should **end on reflection, not resolution.**

### **Prompts:**

* “What did you learn about yourself through this reflection?”

* “What shifted for you as you moved through these steps?”

* “How might you carry this awareness into your next interaction?”

* “What would alignment look like if both of you were at your best?”

---

## **9\. Governance & Use**

* Each prompt must always pass through the **system \+ context \+ directive** layers defined in `/governance/flow-engine.md`.

* Developers may select or randomize prompts from each phase, but all AI calls must include:

  * Current phase

  * User’s “why”

  * Last reflection summary

* No prompt should ever:

  * Assign blame or responsibility to one parent.

  * Imply therapeutic interpretation.

  * Violate the trauma-informed tone.

---

## **10\. Developer Implementation Notes**

To integrate dynamically:

`// Example: Selecting a prompt`  
`import prompts from '@/governance/prompt-library.json'; // or markdown parser`

`function getPrompt(phase: FlowPhase, readiness: number): string {`  
  `const phasePrompts = prompts[phase];`  
  `if (readiness < 0.7) return random(phasePrompts.reprompt);`  
  `return random(phasePrompts.primary);`  
`}`

### **Optional JSON Version (for Supabase storage)**

Each phase can be stored as a JSON array for retrieval from the database:

`{`  
  `"issue": {`  
    `"primary": ["What's been hardest to navigate lately?"],`  
    `"reprompt": ["What about this feels most important to talk through first?"]`  
  `},`  
  `"feelings": {`  
    `"primary": ["What emotions come up for you when this happens?"],`  
    `"reprompt": ["What do you think that feeling is trying to tell you?"]`  
  `}`  
`}`

---

## **11\. Adaptation Clause**

This prompt library may expand over time with input from certified BeH2O® Coaches and reflection data analysis.  
 All additions must preserve the **BeH2O® voice** — calm, grounded, and purpose-driven — and align with BeAligned™’s commitment to **transform conflict into collaboration.**

**Be Strong. Be Grounded. BeAligned.™**

yes, generate JSON-ready export file

###### **ChatGPT said:**

Perfect. Below is a **JSON-ready export** of the full BeAligned™ Prompt Library — one object per reflection phase.

You can save this as  
 📄 `/governance/prompt-library.json`  
 or upload it to **Supabase Storage** so your Edge Functions or React hooks can dynamically pull from it.

It’s formatted for direct import into TypeScript or Node (`import prompts from '@/governance/prompt-library.json'`) and supports flexible use in your Reflective Loop or Prompt Loader.

---

`{`  
  `"issue": {`  
    `"goal": "Help the user name the surface challenge clearly and without judgment.",`  
    `"mindset": "Name the storm without becoming it.",`  
    `"primary": [`  
      `"What’s been feeling hardest to navigate lately?",`  
      `"Tell me what’s happening in your co-parenting dynamic right now.",`  
      `"If you had to summarize the main challenge in one sentence, what would it be?",`  
      `"What part of this situation feels unclear or stuck?",`  
      `"Describe what’s been most stressful for you this week."`  
    `],`  
    `"reprompt": [`  
      `"That makes sense. What about this situation feels most important to talk through first?",`  
      `"What do you wish your co-parent could understand about this?"`  
    `],`  
    `"transition": "Advance when the user can describe the issue without blame and readiness ≥ 0.7; move to 'feelings'."`  
  `},`

  `"feelings": {`  
    `"goal": "Surface the emotions underlying the situation to reduce reactivity and increase awareness.",`  
    `"mindset": "When we can name what we feel, we can choose how to heal.",`  
    `"primary": [`  
      `"What emotions come up for you when this happens?",`  
      `"How do you feel in those moments?",`  
      `"Where do you notice that emotion in your body?",`  
      `"What emotion feels strongest right now — frustration, sadness, fear, something else?",`  
      `"If your emotion could speak, what would it say?"`  
    `],`  
    `"reprompt": [`  
      `"It sounds intense. What do you think that feeling is trying to tell you?",`  
      `"If your child were watching this moment, what would they notice about your feelings?"`  
    `],`  
    `"transition": "Advance when the user expresses at least one emotion clearly and emotional tone stabilizes; move to 'why'."`  
  `},`

  `"why": {`  
    `"goal": "Connect emotion and experience to underlying purpose, value, or need.",`  
    `"mindset": "The 'because' reveals the 'why.'",`  
    `"primary": [`  
      `"What matters most to you about this situation?",`  
      `"Why is this important for you and your child?",`  
      `"If this went well, what would that represent for you?",`  
      `"What do you want your child to learn from how you handle this?",`  
      `"What’s the deeper value beneath your frustration?"`  
    `],`  
    `"reprompt": [`  
      `"That’s a strong why. Is there another layer underneath that?",`  
      `"Sometimes our why points to something we’re trying to protect. What might that be?"`  
    `],`  
    `"transition": "Advance when user articulates a purpose or value beyond emotion and readiness ≥ 0.75; move to 'perspective'."`  
  `},`

  `"perspective": {`  
    `"goal": "Invite empathy and awareness of how others, especially the child, might experience the situation.",`  
    `"mindset": "Perspective isn’t agreement; it’s understanding.",`  
    `"primary": [`  
      `"How do you think your co-parent might be feeling in this situation?",`  
      `"If your child could describe what’s happening between you both, what might they say?",`  
      `"What do you think your co-parent hopes will happen here?",`  
      `"When you step into the child’s shoes, what might they need most?",`  
      `"How might this look from a third side — someone neutral, like a teacher or friend?"`  
    `],`  
    `"reprompt": [`  
      `"What do you notice when you imagine it through your child’s eyes?",`  
      `"Even if you don’t agree, can you see what might be motivating your co-parent’s choices?"`  
    `],`  
    `"transition": "Advance when user acknowledges another perspective with curiosity, not defensiveness; move to 'options'."`  
  `},`

  `"options": {`  
    `"goal": "Generate multiple potential paths forward that serve both parents and the child.",`  
    `"mindset": "When we stay curious, possibilities multiply.",`  
    `"primary": [`  
      `"What are a few ways this could go differently next time?",`  
      `"What could help reduce tension in this situation?",`  
      `"What would ‘better’ look like for you and your co-parent?",`  
      `"If you could choose three realistic steps forward, what might they be?",`  
      `"What have you already tried that worked even a little?"`  
    `],`  
    `"reprompt": [`  
      `"Let’s aim for small, doable steps. What’s one thing you could try in the next week?",`  
      `"Which option feels most possible given where things are right now?"`  
    `],`  
    `"transition": "Advance when user identifies at least two actionable ideas and readiness ≥ 0.7; move to 'choose'."`  
  `},`

  `"choose": {`  
    `"goal": "Select one aligned, realistic action that reflects the user’s 'why.'",`  
    `"mindset": "Choice transforms clarity into change.",`  
    `"primary": [`  
      `"Which of these options feels most aligned with your why?",`  
      `"What step would make the biggest difference right now?",`  
      `"If you chose one thing to model for your child this week, what would it be?",`  
      `"Which choice helps you stay grounded and in integrity?",`  
      `"What does your best parenting self want to do here?"`  
    `],`  
    `"reprompt": [`  
      `"If this option feels too big, what’s a smaller version of the same idea?",`  
      `"What might help you follow through on this choice?"`  
    `],`  
    `"transition": "Advance when user identifies one specific, value-aligned action; move to 'message'."`  
  `},`

  `"message": {`  
    `"goal": "Transform insights into CLEAR communication that can be shared listener-ready.",`  
    `"mindset": "What’s clear is kind.",`  
    `"primary": [`  
      `"Would you like to practice how to say that to your co-parent?",`  
      `"How can you phrase that so it’s easy for them to hear?",`  
      `"What would this message sound like if it were concise and calm?",`  
      `"How might you open this message with appreciation or neutrality?",`  
      `"Let’s craft it in a way that centers your child’s stability."`  
    `],`  
    `"reprompt": [`  
      `"That’s close. Want to see if it passes the CLEAR test?",`  
      `"What might make this message easier for the other person to receive?"`  
    `],`  
    `"transition": "Advance when CLEAR score ≥ 0.8 and message aligns with mutual goals; end reflection session."`  
  `},`

  `"final": {`  
    `"goal": "Encourage self-reflection and accountability at session end.",`  
    `"mindset": "Reflection sustains alignment.",`  
    `"primary": [`  
      `"What did you learn about yourself through this reflection?",`  
      `"What shifted for you as you moved through these steps?",`  
      `"How might you carry this awareness into your next interaction?",`  
      `"What would alignment look like if both of you were at your best?"`  
    `],`  
    `"transition": "Close session with reflection summary and readiness reset."`  
  `}`  
`}`

---

### **✅ Implementation Tips**

* **Store this JSON in Supabase Storage** (e.g., `/prompts/prompt-library.json`) or in a local `/src/data` folder.

* **Fetch dynamically** based on the current `phase` and `readiness` level.

* Each Edge Function (`ai-reflect`, `ai-clear`, `ai-balance`) can pull the right phase block and insert its `primary` or `reprompt` list into the system message.

* You can also add a `"tone"` property later (e.g., `"calm"`, `"motivational"`) for style tuning or coach-specific personalization.

yes generate typescript utility file

###### **ChatGPT said:**

Excellent — here’s your production-ready TypeScript utility.  
 Save it as  
 📄 **`/src/lib/getPrompt.ts`**

This helper automatically loads the JSON prompt library, selects the correct phase, and chooses a *primary* or *reprompt* question depending on readiness. It’s designed to work seamlessly inside your **Reflective Loop**, **React Hooks**, or **Supabase Edge Function** calls.

---

`/**`  
 `* getPrompt.ts`  
 `* Utility for retrieving BeAligned™ reflection prompts`  
 `* -----------------------------------------------------`  
 `* Loads /governance/prompt-library.json and returns a`  
 `* contextually appropriate question for the current phase.`  
 `*`  
 `* Part of the BeH2O® / BeAligned™ Coaching System`  
 `* (c) The Layne Project, LLC — All Rights Reserved`  
 `*/`

`import prompts from '@/governance/prompt-library.json';`

`/**`  
 `* A union of all defined reflection phases`  
 `*/`  
`export type FlowPhase =`  
  `| 'issue'`  
  `| 'feelings'`  
  `| 'why'`  
  `| 'perspective'`  
  `| 'options'`  
  `| 'choose'`  
  `| 'message'`  
  `| 'final';`

`/**`  
 `* Return a random element from an array`  
 `*/`  
`function random<T>(arr: T[]): T {`  
  `return arr[Math.floor(Math.random() * arr.length)];`  
`}`

`/**`  
 `* Determines the appropriate prompt category based on readiness.`  
 `*`  
 `* @param phase - current flow phase (issue → message)`  
 `* @param readiness - AI-estimated clarity score (0–1)`  
 `* @returns a prompt string from the BeAligned™ library`  
 `*/`  
`export function getPrompt(phase: FlowPhase, readiness: number = 0): string {`  
  `const block = (prompts as Record<string, any>)[phase];`

  `if (!block) {`  
    ``console.warn(`⚠️ No prompt block found for phase: ${phase}`);``  
    `return 'Tell me more about what’s happening for you right now.';`  
  `}`

  `const primary = block.primary || [];`  
  `const reprompt = block.reprompt || [];`

  `// Select a re-prompt if readiness < 0.7 and a list exists`  
  `if (readiness < 0.7 && reprompt.length > 0) {`  
    `return random(reprompt);`  
  `}`

  `// Otherwise select a primary prompt`  
  `if (primary.length > 0) {`  
    `return random(primary);`  
  `}`

  `// Fallback (if library incomplete)`  
  `return 'What feels most important to talk about next?';`  
`}`

`/**`  
 `* Returns both the prompt and a structured payload that`  
 `* can be logged or sent to the AI model for context.`  
 `*/`  
`export function getPromptContext(`  
  `phase: FlowPhase,`  
  `readiness: number = 0`  
`): {`  
  `prompt: string;`  
  `goal: string;`  
  `mindset: string;`  
  `transition: string;`  
`} {`  
  `const block = (prompts as Record<string, any>)[phase];`  
  `if (!block) {`  
    `return {`  
      `prompt: 'What feels most important to talk about next?',`  
      `goal: '',`  
      `mindset: '',`  
      `transition: ''`  
    `};`  
  `}`

  `const prompt = getPrompt(phase, readiness);`

  `return {`  
    `prompt,`  
    `goal: block.goal || '',`  
    `mindset: block.mindset || '',`  
    `transition: block.transition || ''`  
  `};`  
`}`

`/**`  
 `* Example usage:`  
 `*`  
 `* import { getPromptContext } from '@/lib/getPrompt';`  
 `*`  
 `* const { prompt, goal, mindset } = getPromptContext('why', 0.6);`  
 `* console.log(prompt); // "That’s a strong why. Is there another layer underneath that?"`  
 `*/`

---

### **✅ Developer Notes**

**How it works**

* Automatically detects whether the user needs a *re-prompt* or can advance with a *primary* question.

* If the JSON library evolves (e.g., new phases or fields), this file will adapt automatically.

* Can be extended for coach-specific tone or localization.

**Integration Example**

`import { getPromptContext } from '@/lib/getPrompt';`

`async function handleUserResponse(currentPhase: FlowPhase, readiness: number) {`  
  `const { prompt } = getPromptContext(currentPhase, readiness);`

  `// Display next question in UI`  
  `setNextPrompt(prompt);`

  `// Optionally send prompt back to AI model:`  
  ``await fetch(`${SUPABASE_URL}/functions/v1/ai-reflect`, {``  
    `method: 'POST',`  
    `headers: { 'Content-Type': 'application/json' },`  
    `body: JSON.stringify({ phase: currentPhase, prompt })`  
  `});`  
`}`

yes generate edge function

###### **ChatGPT said:**

Perfect — here’s a **Supabase Edge Function** version that dynamically retrieves the BeAligned™ prompt library from **Supabase Storage**, selects the correct phase and prompt (primary or reprompt), and returns it as JSON for your React app or Edge Functions to use.

Save this as:  
 📄 **`/supabase/functions/get-prompt/index.ts`**

---

`/**`  
 `* get-prompt Edge Function`  
 `* -----------------------------------------------------`  
 `* Dynamically retrieves the BeAligned™ prompt library from`  
 `* Supabase Storage, selects the correct reflection prompt,`  
 `* and returns it to the client.`  
 `*`  
 `* This function allows prompts to be updated without`  
 `* redeploying the app — keeping all AI interactions aligned`  
 `* with the BeH2O® voice and BeAligned™ governance.`  
 `*`  
 `* © The Layne Project, LLC — All Rights Reserved`  
 `*/`

`import { Hono } from 'https://esm.sh/hono@3';`  
`import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';`

`const app = new Hono();`

`interface PromptRequest {`  
  `phase: string;`  
  `readiness?: number; // 0–1`  
  `bucket?: string;    // optional custom bucket name`  
  `path?: string;      // optional file path`  
`}`

`function random<T>(arr: T[]): T {`  
  `return arr[Math.floor(Math.random() * arr.length)];`  
`}`

`app.post('/', async (c) => {`  
  `const supabase = createClient(`  
    `Deno.env.get('SUPABASE_URL')!,`  
    `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!`  
  `);`

  `const { phase, readiness = 0.5, bucket = 'governance', path = 'prompt-library.json' } =`  
    `(await c.req.json()) as PromptRequest;`

  `try {`  
    `// 1️⃣ Fetch prompt library file from Supabase Storage`  
    `const { data, error } = await supabase.storage.from(bucket).download(path);`  
    `if (error || !data) {`  
      `console.error(error);`  
      `return c.json({ error: 'Unable to load prompt library from storage.' }, 500);`  
    `}`

    `const text = await data.text();`  
    `const library = JSON.parse(text);`  
    `const block = library[phase];`

    `if (!block) {`  
      `return c.json({`  
        `prompt: 'What feels most important to talk about next?',`  
        `phase,`  
        `note: 'No prompt block found for this phase.'`  
      `});`  
    `}`

    `const primary = block.primary || [];`  
    `const reprompt = block.reprompt || [];`

    `// 2️⃣ Choose primary or re-prompt`  
    `let chosenPrompt: string;`  
    `if (readiness < 0.7 && reprompt.length > 0) {`  
      `chosenPrompt = random(reprompt);`  
    `} else if (primary.length > 0) {`  
      `chosenPrompt = random(primary);`  
    `} else {`  
      `chosenPrompt = 'What feels most important to talk about next?';`  
    `}`

    `// 3️⃣ Construct payload with context metadata`  
    `const response = {`  
      `phase,`  
      `readiness,`  
      `prompt: chosenPrompt,`  
      `goal: block.goal || '',`  
      `mindset: block.mindset || '',`  
      `transition: block.transition || ''`  
    `};`

    `return c.json(response);`  
  `} catch (err) {`  
    `console.error('Error retrieving prompt:', err);`  
    `return c.json({ error: 'Internal server error', details: String(err) }, 500);`  
  `}`  
`});`

`export default app;`

---

## **🪜 Deployment Instructions**

**Add prompt file to Supabase Storage**  
 Upload your JSON prompt library (`prompt-library.json`) to the bucket `governance`:

 `supabase storage create-bucket governance --public=false`  
`supabase storage upload governance/prompt-library.json ./governance/prompt-library.json`

1. 

**Deploy Edge Function**

 `supabase functions deploy get-prompt`  
`supabase functions list`

2. 

**Example Client Call (React Native or Edge Function)**

 ``const res = await fetch(`${SUPABASE_URL}/functions/v1/get-prompt`, {``  
  `method: 'POST',`  
  `headers: { 'Content-Type': 'application/json' },`  
  `body: JSON.stringify({`  
    `phase: 'feelings',`  
    `readiness: 0.5`  
  `})`  
`});`

`const data = await res.json();`  
`console.log('Next prompt:', data.prompt);`

3. 

---

## **🔐 Security & Governance**

* Store prompt file in a **non-public bucket** (`governance`) for integrity.

* Use only the **service role key** in Edge Functions (never in client).

* This ensures the **coaching voice** stays centrally governed and cannot be tampered with at runtime.

* If you later version prompts (e.g., `/v2/prompt-library.json`), the same function will automatically pick up the new version once replaced.

---

## **✅ Example Response**

`{`  
  `"phase": "why",`  
  `"readiness": 0.65,`  
  `"prompt": "That’s a strong why. Is there another layer underneath that?",`  
  `"goal": "Connect emotion and experience to underlying purpose, value, or need.",`  
  `"mindset": "The 'because' reveals the 'why.'",`  
  `"transition": "Advance when user articulates a purpose or value beyond emotion and readiness ≥ 0.75; move to 'perspective'."`  
`}`

Excellent — here’s your **React Native client hook** designed to connect seamlessly with the  
 🧠 `get-prompt` Edge Function you just deployed.

Save it as:  
 📄 **`/src/hooks/usePrompt.ts`**

---

`/**`  
 `* usePrompt.ts`  
 `* -----------------------------------------------------`  
 `* React Hook for fetching BeAligned™ reflection prompts`  
 ``* from the Supabase Edge Function `/functions/v1/get-prompt`.``  
 `*`  
 `* Handles loading state, caching, and readiness-based`  
 `* selection logic to maintain conversational flow.`  
 `*`  
 `* © The Layne Project, LLC — All Rights Reserved`  
 `*/`

`import { useState, useCallback } from 'react';`

`/**`  
 `* Type definitions for BeAligned™ reflection flow.`  
 `*/`  
`export type FlowPhase =`  
  `| 'issue'`  
  `| 'feelings'`  
  `| 'why'`  
  `| 'perspective'`  
  `| 'options'`  
  `| 'choose'`  
  `| 'message'`  
  `| 'final';`

`export interface PromptResponse {`  
  `phase: FlowPhase;`  
  `readiness: number;`  
  `prompt: string;`  
  `goal?: string;`  
  `mindset?: string;`  
  `transition?: string;`  
`}`

`/**`  
 `* React Hook: usePrompt`  
 `* Fetches a phase-specific prompt from the Supabase Edge Function.`  
 `*`  
 ``* @param baseUrl - Your Supabase function URL (e.g. `${SUPABASE_URL}/functions/v1`)``  
 `* @returns { getPrompt, loading, error, data }`  
 `*/`  
`export function usePrompt(baseUrl: string) {`  
  `const [data, setData] = useState<PromptResponse | null>(null);`  
  `const [loading, setLoading] = useState(false);`  
  `const [error, setError] = useState<string | null>(null);`

  `/**`  
   `* Request a new prompt for the given phase + readiness`  
   `*/`  
  `const getPrompt = useCallback(`  
    `async (phase: FlowPhase, readiness: number = 0.5): Promise<PromptResponse | null> => {`  
      `setLoading(true);`  
      `setError(null);`

      `try {`  
        ``const response = await fetch(`${baseUrl}/get-prompt`, {``  
          `method: 'POST',`  
          `headers: { 'Content-Type': 'application/json' },`  
          `body: JSON.stringify({ phase, readiness })`  
        `});`

        `if (!response.ok) {`  
          `const text = await response.text();`  
          ``throw new Error(`HTTP ${response.status}: ${text}`);``  
        `}`

        `const result = (await response.json()) as PromptResponse;`  
        `setData(result);`  
        `return result;`  
      `} catch (err: any) {`  
        `console.error('❌ usePrompt error:', err);`  
        `setError(err.message || 'Failed to fetch prompt');`  
        `return null;`  
      `} finally {`  
        `setLoading(false);`  
      `}`  
    `},`  
    `[baseUrl]`  
  `);`

  `return { getPrompt, data, loading, error };`  
`}`

`/**`  
 `* Example Usage in a React Component`  
 `* ----------------------------------`  
 `*`  
 `* import { usePrompt } from '@/hooks/usePrompt';`  
 `*`  
 `* const { getPrompt, data, loading } = usePrompt(SUPABASE_FUNCTIONS_URL);`  
 `*`  
 `* async function handleNextPhase() {`  
 `*   const promptData = await getPrompt('feelings', 0.6);`  
 `*   if (promptData) setNextPrompt(promptData.prompt);`  
 `* }`  
 `*`  
 `* // Render`  
 `* {loading ? <Spinner /> : <Text>{data?.prompt}</Text>}`  
 `*/`

---

### **✅ Integration Notes**

**Environment Variable**

 `EXPO_PUBLIC_SUPABASE_FUNCTIONS_URL="https://<your-project>.functions.supabase.co"`  
 Then import:

 `const { getPrompt, data } = usePrompt(process.env.EXPO_PUBLIC_SUPABASE_FUNCTIONS_URL!);`

1.   
2. **Caching Option**

You can wrap this hook in `React Query` or `SWR` for caching between phases:

 `const { data } = useQuery(['prompt', phase], () => getPrompt(phase, readiness));`

*   
3. **Connection to Flow Engine**

   * This hook slots directly into your `/src/context/FlowProvider.tsx`.

Each time the user completes a reflection input, call:

 `const next = await getPrompt(currentPhase, readiness);`  
`updateFlowState(next);`

*   
4. **Offline Handling**

   * If `error` is set, gracefully fallback to a local `prompt-library.json` (cached version).

---

### **🧩 Example Flow Integration**

`import { usePrompt } from '@/hooks/usePrompt';`  
`import { useEffect } from 'react';`  
`import { Text, Button } from 'react-native';`

`export default function ReflectionScreen({ currentPhase, readiness }) {`  
  `const { getPrompt, data, loading } = usePrompt(process.env.EXPO_PUBLIC_SUPABASE_FUNCTIONS_URL!);`

  `useEffect(() => {`  
    `getPrompt(currentPhase, readiness);`  
  `}, [currentPhase]);`

  `return (`  
    `<>`  
      `{loading && <Text>Thinking...</Text>}`  
      `{!loading && <Text style={{ fontSize: 18 }}>{data?.prompt}</Text>}`  
      `<Button title="Next" onPress={() => getPrompt(currentPhase, readiness)} />`  
    `</>`  
  `);`  
`}`

---

### **🔒 Governance Notes**

* This hook **only calls the Edge Function**; it does not hold or modify system prompts itself.

* All BeH2O® tone, readiness rules, and phase progression remain enforced inside the `/functions/v1/get-prompt` governance.

* If new prompts or tone adjustments are uploaded to Supabase Storage, the app updates instantly — no redeploy required.

---

yes generate context file

###### **ChatGPT said:**

Excellent — this is the missing connective tissue that makes BeAligned™ “feel alive.”  
 Below is a complete, production-ready **React Context Provider** that integrates:

* the `usePrompt` hook you just built,

* dynamic `FlowState` management,

* readiness and phase transitions, and

* real-time UI synchronization.

Save as 📄 **`/src/context/FlowProvider.tsx`**

---

`/**`  
 `* FlowProvider.tsx`  
 `* -----------------------------------------------------`  
 `* Central context for managing BeAligned™ conversation flow.`  
 `* Orchestrates phases, readiness, prompts, and AI reflection`  
 `* loops across the app.`  
 `*`  
 `* Built on BeH2O® & BeAligned™ governance principles:`  
 `*  - Host reflection, not fix problems`  
 `*  - Move only when clarity emerges (readiness ≥ 0.7)`  
 `*  - Always safeguard childhoods`  
 `*`  
 `* © The Layne Project, LLC — All Rights Reserved`  
 `*/`

`import React, {`  
  `createContext,`  
  `useState,`  
  `useContext,`  
  `useCallback,`  
  `ReactNode`  
`} from 'react';`  
`import { usePrompt, FlowPhase, PromptResponse } from '@/hooks/usePrompt';`

`/**`  
 `* The FlowState interface mirrors governance definitions.`  
 `*/`  
`export interface FlowState {`  
  `id: string;`  
  `userId?: string;`  
  `currentPhase: FlowPhase;`  
  `context: {`  
    `issue?: string;`  
    `feelings?: string;`  
    `why?: string;`  
    `perspective?: string;`  
    `options?: string[];`  
    `chosenOption?: string;`  
  `};`  
  `readiness: number;             // clarity 0–1`  
  `prompt: string;                // current question`  
  `lastResponse?: string;         // user’s last answer`  
  `history: Array<{ phase: FlowPhase; prompt: string; response: string }>;`  
`}`

`/**`  
 `* Context shape`  
 `*/`  
`interface FlowContextType {`  
  `flow: FlowState;`  
  `loading: boolean;`  
  `nextPrompt: () => Promise<void>;`  
  `recordResponse: (text: string) => void;`  
  `resetFlow: () => void;`  
`}`

`const FlowContext = createContext<FlowContextType | undefined>(undefined);`

`/**`  
 `* Provider Component`  
 `*/`  
`export const FlowProvider = ({`  
  `children,`  
  `userId`  
`}: {`  
  `children: ReactNode;`  
  `userId: string;`  
`}) => {`  
  `const { getPrompt, data, loading } = usePrompt(`  
    `process.env.EXPO_PUBLIC_SUPABASE_FUNCTIONS_URL!`  
  `);`

  `const [flow, setFlow] = useState<FlowState>({`  
    `id: crypto.randomUUID(),`  
    `userId,`  
    `currentPhase: 'issue',`  
    `readiness: 0,`  
    `prompt: '',`  
    `context: {},`  
    `history: []`  
  `});`

  `/**`  
   `* Request next prompt from Edge Function`  
   `*/`  
  `const nextPrompt = useCallback(async () => {`  
    `const response = await getPrompt(flow.currentPhase, flow.readiness);`  
    `if (!response) return;`

    `setFlow(prev => ({`  
      `...prev,`  
      `prompt: response.prompt,`  
      `readiness: response.readiness,`  
      `history: [`  
        `...prev.history,`  
        `{`  
          `phase: prev.currentPhase,`  
          `prompt: response.prompt,`  
          `response: prev.lastResponse || ''`  
        `}`  
      `]`  
    `}));`  
  `}, [flow.currentPhase, flow.readiness, getPrompt]);`

  `/**`  
   `* Record user response and manage progression`  
   `*/`  
  `const recordResponse = useCallback(`  
    `(text: string) => {`  
      `setFlow(prev => {`  
        `// Update current context with user response`  
        `const updatedContext = { ...prev.context, [prev.currentPhase]: text };`

        `// Evaluate readiness-based transitions`  
        `let nextPhase: FlowPhase = prev.currentPhase;`  
        `if (prev.readiness >= 0.7) {`  
          `const order: FlowPhase[] = [`  
            `'issue',`  
            `'feelings',`  
            `'why',`  
            `'perspective',`  
            `'options',`  
            `'choose',`  
            `'message',`  
            `'final'`  
          `];`  
          `const idx = order.indexOf(prev.currentPhase);`  
          `if (idx < order.length - 1) {`  
            `nextPhase = order[idx + 1];`  
          `}`  
        `}`

        `return {`  
          `...prev,`  
          `context: updatedContext,`  
          `lastResponse: text,`  
          `currentPhase: nextPhase`  
        `};`  
      `});`

      `// After recording, trigger next reflection prompt`  
      `nextPrompt();`  
    `},`  
    `[nextPrompt]`  
  `);`

  `/**`  
   `* Reset the full conversation flow`  
   `*/`  
  `const resetFlow = useCallback(() => {`  
    `setFlow({`  
      `id: crypto.randomUUID(),`  
      `userId,`  
      `currentPhase: 'issue',`  
      `readiness: 0,`  
      `prompt: '',`  
      `context: {},`  
      `history: []`  
    `});`  
  `}, [userId]);`

  `const value: FlowContextType = {`  
    `flow,`  
    `loading,`  
    `nextPrompt,`  
    `recordResponse,`  
    `resetFlow`  
  `};`

  `return <FlowContext.Provider value={value}>{children}</FlowContext.Provider>;`  
`};`

`/**`  
 `* Hook to use Flow context throughout the app.`  
 `*/`  
`export const useFlow = (): FlowContextType => {`  
  `const context = useContext(FlowContext);`  
  `if (!context) {`  
    `throw new Error('useFlow must be used within a FlowProvider');`  
  `}`  
  `return context;`  
`};`

---

## **🧭 How It Works**

1. **Initialization**

   * Starts at phase `"issue"`.

   * Requests a prompt using your Supabase Edge Function (`get-prompt`).

   * Stores conversation metadata (phase, readiness, history, etc.).

2. **Flow Loop**

   * User answers → `recordResponse()` updates context.

   * If readiness ≥ 0.7 → advances to next phase.

   * Then automatically requests next prompt from the Edge Function.

   * The app dynamically renders `flow.prompt` for each turn.

3. **Resets**

   * `resetFlow()` clears the session for a new reflection journey.

---

## **🪞 Example Usage**

`import React, { useEffect, useState } from 'react';`  
`import { TextInput, Button, Text, View } from 'react-native';`  
`import { FlowProvider, useFlow } from '@/context/FlowProvider';`

`function ReflectionSession() {`  
  `const { flow, loading, recordResponse, resetFlow } = useFlow();`  
  `const [input, setInput] = useState('');`

  `useEffect(() => {`  
    `if (!flow.prompt) {`  
      `// Trigger first question on mount`  
      `recordResponse('');`  
    `}`  
  `}, []);`

  `return (`  
    `<View style={{ padding: 20 }}>`  
      `<Text style={{ fontSize: 18, marginBottom: 10 }}>`  
        `{loading ? 'Thinking...' : flow.prompt}`  
      `</Text>`

      `<TextInput`  
        `placeholder="Type your reflection here..."`  
        `multiline`  
        `style={{`  
          `borderWidth: 1,`  
          `borderColor: '#ccc',`  
          `borderRadius: 10,`  
          `padding: 12,`  
          `marginBottom: 10`  
        `}}`  
        `value={input}`  
        `onChangeText={setInput}`  
      `/>`

      `<Button`  
        `title="Submit Reflection"`  
        `onPress={() => {`  
          `recordResponse(input);`  
          `setInput('');`  
        `}}`  
      `/>`  
      `<Button title="Reset Session" onPress={resetFlow} />`  
    `</View>`  
  `);`  
`}`

`// Wrap your app with the FlowProvider in _layout.tsx or App.tsx`  
`export default function App() {`  
  `const userId = 'mock-user-id'; // replace with Auth session user.id`  
  `return (`  
    `<FlowProvider userId={userId}>`  
      `<ReflectionSession />`  
    `</FlowProvider>`  
  `);`  
`}`

---

## **⚙️ Notes for Robert & Developers**

| Component | Purpose | Source |
| ----- | ----- | ----- |
| `usePrompt` | Retrieves next question from Supabase Edge Function | `/src/hooks/usePrompt.ts` |
| `FlowProvider` | Manages entire reflection flow, transitions, and state | `/src/context/FlowProvider.tsx` |
| `recordResponse()` | Saves user response, updates readiness, and triggers next reflection | Provided by context |
| `nextPrompt()` | Manually fetches next AI-guided prompt | Provided by context |

**Design Principle:**  
 The app “thinks” like a BeH2O® coach because it moves *only when readiness and reflection align*, not when the user clicks “Next.”

Perfect — this is the final piece of your **BeAligned™ Reflection Engine**: the hook that connects your  
 🧠 **FlowProvider** (which manages state and phase transitions)  
 to your 🔗 **`ai-reflect` Edge Function** (which provides reflection summaries, readiness scores, and next-phase signals).

This creates the true “Reflective Loop,” enabling your React app to **think, pause, and re-prompt** like a BeH2O® coach.

Save this as:  
 📄 **`/src/hooks/useReflection.ts`**

---

`/**`  
 `* useReflection.ts`  
 `* -----------------------------------------------------`  
 `* Connects FlowProvider state with the ai-reflect Edge Function.`  
 `* Handles sending user reflections to Supabase, receiving`  
 `* AI-generated summaries, readiness scores, and suggested transitions.`  
 `*`  
 `* Integrates directly with FlowProvider and the BeAligned™ system.`  
 `*`  
 `* © The Layne Project, LLC — All Rights Reserved`  
 `*/`

`import { useState, useCallback } from 'react';`  
`import { FlowPhase } from '@/context/FlowProvider';`

`/**`  
 `* Type definitions for AI Reflection response.`  
 `*/`  
`export interface ReflectionResult {`  
  `summary: string;`  
  `next_prompt: string;`  
  `readiness: number;`  
  `suggested_next_phase?: FlowPhase | null;`  
  `alignment_score?: number;`  
`}`

`/**`  
 `* useReflection`  
 `* ----------------------------------------------------------------`  
 `* Hook that posts reflection data to the ai-reflect Edge Function`  
 `* and returns the processed response.`  
 `*`  
 ``* @param baseUrl Supabase function URL (e.g. `${SUPABASE_URL}/functions/v1`)``  
 `* @returns { reflect, data, loading, error }`  
 `*/`  
`export function useReflection(baseUrl: string) {`  
  `const [data, setData] = useState<ReflectionResult | null>(null);`  
  `const [loading, setLoading] = useState(false);`  
  `const [error, setError] = useState<string | null>(null);`

  `/**`  
   `* Send user reflection to ai-reflect and retrieve AI analysis`  
   `*/`  
  `const reflect = useCallback(`  
    `async (params: {`  
      `user_id: string;`  
      `phase: FlowPhase;`  
      `content: string;`  
    `}): Promise<ReflectionResult | null> => {`  
      `setLoading(true);`  
      `setError(null);`

      `try {`  
        ``const response = await fetch(`${baseUrl}/ai-reflect`, {``  
          `method: 'POST',`  
          `headers: { 'Content-Type': 'application/json' },`  
          `body: JSON.stringify(params)`  
        `});`

        `if (!response.ok) {`  
          `const text = await response.text();`  
          ``throw new Error(`HTTP ${response.status}: ${text}`);``  
        `}`

        `const result = await response.json();`  
        `const parsed = result?.result || result?.reflection || result; // handle variations`

        `const reflection: ReflectionResult = {`  
          `summary: parsed.summary || '',`  
          `next_prompt: parsed.next_prompt || '',`  
          `readiness: parsed.readiness ?? 0,`  
          `suggested_next_phase: parsed.suggested_next_phase || null,`  
          `alignment_score: parsed.alignment_score ?? null`  
        `};`

        `setData(reflection);`  
        `return reflection;`  
      `} catch (err: any) {`  
        `console.error('❌ useReflection error:', err);`  
        `setError(err.message || 'Failed to reflect');`  
        `return null;`  
      `} finally {`  
        `setLoading(false);`  
      `}`  
    `},`  
    `[baseUrl]`  
  `);`

  `return { reflect, data, loading, error };`  
`}`

`/**`  
 `* Example Usage:`  
 `* ----------------------------------------------------------------`  
 `* import { useReflection } from '@/hooks/useReflection';`  
 `*`  
 `* const { reflect, data, loading } = useReflection(SUPABASE_FUNCTIONS_URL);`  
 `*`  
 `* async function handleUserInput(input: string) {`  
 `*   const res = await reflect({`  
 `*     user_id: session.user.id,`  
 `*     phase: flow.currentPhase,`  
 `*     content: input`  
 `*   });`  
 `*   if (res) {`  
 `*     updateFlowState({`  
 `*       readiness: res.readiness,`  
 `*       nextPrompt: res.next_prompt,`  
 `*       summary: res.summary`  
 `*     });`  
 `*   }`  
 `* }`  
 `*/`

---

## **🧭 How It Fits Into the Ecosystem**

| Component | Purpose | Connects To |
| ----- | ----- | ----- |
| **`usePrompt`** | Fetches static BeAligned™ prompts from Supabase Storage | `/functions/v1/get-prompt` |
| **`useReflection`** | Sends user input to AI for analysis and readiness scoring | `/functions/v1/ai-reflect` |
| **`FlowProvider`** | Manages phases, readiness, and transitions | Uses both hooks above |
| **`ai-reflect` Edge Function** | AI “brain” returning summaries, readiness, and next prompts | Supabase Function layer |

---

## **🪞 Example Integration in FlowProvider**

Add this inside `/src/context/FlowProvider.tsx` to complete the loop:

`import { useReflection } from '@/hooks/useReflection';`

`// Inside FlowProvider`  
`const { reflect } = useReflection(process.env.EXPO_PUBLIC_SUPABASE_FUNCTIONS_URL!);`

`const recordResponse = useCallback(`  
  `async (text: string) => {`  
    `// 1️⃣ Post reflection to AI`  
    `const ai = await reflect({`  
      `user_id: userId,`  
      `phase: flow.currentPhase,`  
      `content: text`  
    `});`

    `// 2️⃣ Update context based on AI output`  
    `if (ai) {`  
      `const nextPhase =`  
        `ai.readiness >= 0.7`  
          `? ai.suggested_next_phase || getNextPhase(flow.currentPhase)`  
          `: flow.currentPhase;`

      `setFlow(prev => ({`  
        `...prev,`  
        `context: { ...prev.context, [prev.currentPhase]: text },`  
        `lastResponse: text,`  
        `readiness: ai.readiness,`  
        `prompt: ai.next_prompt || prev.prompt,`  
        `currentPhase: nextPhase,`  
        `history: [`  
          `...prev.history,`  
          `{`  
            `phase: prev.currentPhase,`  
            `prompt: prev.prompt,`  
            `response: text`  
          `}`  
        `]`  
      `}));`  
    `}`  
  `},`  
  `[flow.currentPhase, reflect, userId]`  
`);`

---

## **🧩 Testing Notes**

**Run locally with Supabase CLI**

 `supabase functions serve ai-reflect`  
 Then in your Expo app:

 `EXPO_PUBLIC_SUPABASE_FUNCTIONS_URL="http://localhost:54321/functions/v1"`

1. 

**Expected AI response (sample)**

 `{`  
  `"summary": "User feels dismissed by co-parent but wants calmer communication.",`  
  `"next_prompt": "What do you think your co-parent might be feeling in that moment?",`  
  `"readiness": 0.65,`  
  `"suggested_next_phase": null,`  
  `"alignment_score": 0.6`  
`}`

2.   
3. **End-to-End Behavior**

   * User enters reflection → AI analyzes it

   * AI returns summary, readiness, and next question

   * FlowProvider updates state → next phase begins only if readiness ≥ 0.7

   * Result: the app “thinks” like a BeH2O® coach — fluid, purposeful, grounded.

Here’s your **developer-ready README** — a single, cohesive file that documents the full BeAligned™ Beta Lite system: its purpose, architecture, governance, and build flow.  
 Save as 📄 **`README.md`** in the root of your project.

---

# **🌊 BeAligned™ Beta Lite**

*AI-guided reflection system built on the BeH2O® Framework — transforming conflict into alignment.*

---

## **🧭 Overview**

**BeAligned™ Beta Lite** helps parents and professionals pause, reflect, and realign before communicating.  
 It reproduces the voice and logic of a **BeH2O® coach** — grounded, neutral, child-centered — inside a structured React Native \+ Supabase application.

**Core Principle:**

*Host reflection, don’t fix problems.*

The system adapts dynamically to a user’s emotional readiness, moving only when clarity and calm have emerged.

---

## **⚙️ Tech Stack**

| Layer | Technology | Purpose |
| ----- | ----- | ----- |
| **Frontend** | Expo \+ React Native \+ Expo Router | Mobile cross-platform interface |
| **State Mgmt** | React Context \+ Hooks (`FlowProvider`) | Tracks phase, readiness, and conversation flow |
| **Backend DB** | Supabase (PostgreSQL \+ RLS) | Stores reflections, feedback, alignment metrics |
| **Edge Functions** | Supabase Functions (Deno \+ TypeScript) | Hosts Claude/Anthropic logic and governance |
| **AI Model** | Anthropic Claude 3.5 Sonnet | Generates reflections and prompts |
| **Storage** | Supabase Storage | Holds JSON prompt libraries and assets |

---

## **🧩 Core Concepts**

### **BeH2O® Principles**

* **Strength** like Beryllium → stable, principled

* **Flow** like Water → adaptive, responsive

* **Safeguard Childhoods** → apply a child-impact lens

### **Coaching Laws of BeAligned™**

1. Start from Why

2. Hold the Third Side

3. Clarity before Conclusion

4. Listener-Readiness Check (CLEAR framework)

5. Accountability without Judgment

---

## **🧠 System Architecture**

`User Input`  
   `↓`  
`FlowProvider (context)`  
   `↓`  
`useReflection → ai-reflect Edge Function`  
   `↓`  
`Claude API → analyzes + scores readiness`  
   `↓`  
`FlowProvider updates state (phase + prompt)`  
   `↓`  
`usePrompt → get-prompt Edge Function`  
   `↓`  
`Displays next reflection question`

### **Phase Flow**

`issue → feelings → why → perspective → options → choose → message → final`

Each phase has its own **goal**, **mindset**, **prompt set**, and **readiness rules**.

---

## **📁 Directory Structure**

`/src`  
 `├─ /context`  
 `│   └─ FlowProvider.tsx`  
 `├─ /hooks`  
 `│   ├─ usePrompt.ts`  
 `│   ├─ useReflection.ts`  
 `│   └─ useFlowState.ts (optional)`  
 `├─ /lib`  
 `│   └─ getPrompt.ts`  
 `└─ /governance`  
     `├─ flow-engine.md`  
     `├─ prompt-library.md`  
     `└─ prompt-library.json`  
`/supabase`  
 `├─ /functions`  
 `│   ├─ ai-reflect/`  
 `│   ├─ ai-clear/`  
 `│   ├─ ai-balance/`  
 `│   └─ get-prompt/`  
 `└─ /migrations`  
     `└─ 20251011_bealigned_init.sql`

---

## **🧩 Core Files & Purpose**

| File | Description |
| ----- | ----- |
| **`flow-engine.md`** | Defines governance, ethos, readiness logic, and coaching mindset |
| **`prompt-library.json`** | JSON version of prompts (stored in Supabase Storage) |
| **`getPrompt.ts`** | Local utility to retrieve appropriate phase prompt |
| **`usePrompt.ts`** | Hook calling the `get-prompt` Edge Function |
| **`useReflection.ts`** | Hook posting reflections to `ai-reflect` and receiving readiness feedback |
| **`FlowProvider.tsx`** | Central state manager orchestrating reflection phases and AI integration |
| **Edge Functions** | Claude-powered “brains” performing reflection analysis, CLEAR scoring, and boundary coaching |

---

## **🚀 Setup & Deployment**

### **1️⃣ Clone and Install**

`git clone https://github.com/<your-org>/bealigned-lite.git`  
`cd bealigned-lite`  
`npm install`

### **2️⃣ Environment Variables**

Create `.env` or use Expo config:

`EXPO_PUBLIC_SUPABASE_URL=https://<project>.supabase.co`  
`EXPO_PUBLIC_SUPABASE_ANON_KEY=<anon-key>`  
`EXPO_PUBLIC_SUPABASE_FUNCTIONS_URL=https://<project>.functions.supabase.co`  
`ANTHROPIC_API_KEY=<anthropic-key>`

### **3️⃣ Database & Storage**

`supabase db push`  
`supabase storage create-bucket governance --public=false`  
`supabase storage upload governance/prompt-library.json ./governance/prompt-library.json`

### **4️⃣ Deploy Edge Functions**

`supabase functions deploy ai-reflect`  
`supabase functions deploy ai-clear`  
`supabase functions deploy ai-balance`  
`supabase functions deploy get-prompt`

### **5️⃣ Run App**

`npx expo start`

---

## **🪞 Developer Flow Example**

`import { useFlow } from '@/context/FlowProvider';`

`function ReflectionScreen() {`  
  `const { flow, recordResponse, loading } = useFlow();`  
  `const [input, setInput] = useState('');`

  `return (`  
    `<View>`  
      `<Text>{loading ? 'Thinking...' : flow.prompt}</Text>`  
      `<TextInput`  
        `placeholder="Type your reflection..."`  
        `value={input}`  
        `onChangeText={setInput}`  
      `/>`  
      `<Button`  
        `title="Submit"`  
        `onPress={() => {`  
          `recordResponse(input);`  
          `setInput('');`  
        `}}`  
      `/>`  
    `</View>`  
  `);`  
`}`

**Under the hood:**

1. User enters a reflection → `useReflection` sends it to `ai-reflect`.

2. Claude returns summary \+ readiness \+ next prompt.

3. `FlowProvider` updates phase and renders new question via `usePrompt`.

4. Conversation flows until alignment is achieved.

---

## **🔐 Governance & Ethical Safeguards**

* Trauma-informed, non-therapeutic tone

* No diagnostic or prescriptive outputs

* Strict data privacy via Supabase RLS

* Alignment over Neutrality → the system “hosts,” not “fixes”

* Every session ends with a self-reflection, not a directive

---

## **📊 Future Extensions**

| Feature | Description |
| ----- | ----- |
| **`ai-insights` Function** | Aggregate alignment metrics for coach dashboards |
| **Realtime Reflection Feed** | Live updates across devices |
| **Institutional Dashboards** | Aggregate child-impact and alignment analytics |
| **Multilingual Prompts** | International expansion of BeH2O® programs |

---

## **🧭 Design Philosophy**

**Strong like beryllium. Fluid like water. Always safeguard childhoods.**

Every interaction—whether human or AI—should embody:

* **Calm curiosity** instead of control

* **Purposeful progress** over perfection

* **Reflection before reaction**

---

## **🧱 Contributors**

* **Trina Nudson** – Founder & Visionary ( The Layne Project ® )

* **Robert Mann** – Developer & System Architect

* **BeH2O® Certified Coaches** – Voice & Content Auditing

---

## **🩵 License & Attribution**

BeH2O® and BeAligned™ are registered intellectual property of **The Layne Project, LLC**.  
 Code and configuration may be reused under private license with attribution:  
 **“Powered by BeAligned™, built on BeH2O® principles.”**

---

### **✅ End State**

By combining **React Native’s fluid UX**, **Supabase’s secure infrastructure**, and **BeH2O®’s human ethos**,  
 BeAligned™ Beta Lite delivers an AI-guided reflective experience that truly *thinks like a coach.*

**Be Strong. Be Grounded. Be Aligned™.**

---

Would you like me to now generate a **visual system diagram (Mermaid \+ Markdown)** you can embed at the top of this README to show funders or developers how the entire BeAligned™ pipeline flows end-to-end?

ChatGPT can make mistakes. Check important info.

yes generate Mermaid \+ Markdown

###### **ChatGPT said:**

Perfect. Below is a **Mermaid \+ Markdown system diagram** you can paste directly into the top of your `README.md`.

It visually communicates the **BeAligned™ end-to-end flow** — from user reflection through AI processing and back to the app — ideal for funders, collaborators, and developers.

---

## **🧩 BeAligned™ System Flow**

`flowchart TD`

    `%% User Layer`  
    `subgraph A["🧍 User Layer"]`  
        `U[User Input\n(Reflection or Message)]`  
    `end`

    `%% Application Layer`  
    `subgraph B["📱 Application Layer — React Native (Expo)"]`  
        `FP[FlowProvider.tsx\n(Phase, State, Readiness)]`  
        `UP[usePrompt Hook\n(get-prompt Edge Function)]`  
        `UR[useReflection Hook\n(ai-reflect Edge Function)]`  
    `end`

    `%% Backend / Edge Functions`  
    `subgraph C["☁️ Supabase Edge Functions (Deno + TypeScript)"]`  
        `GP[get-prompt\nFetch phase prompts\nfrom Storage]`  
        `AR[ai-reflect\nAnalyze reflection,\nscore readiness]`  
        `AC[ai-clear\nEvaluate CLEAR messaging]`  
        `AB[ai-balance\nGenerate B.A.L.A.N.C.E.\nboundary guidance]`  
        `AI[(Anthropic Claude API)]`  
    `end`

    `%% Data Layer`  
    `subgraph D["🗄️ Supabase Database (PostgreSQL + RLS)"]`  
        `REF[(reflections)]`  
        `COM[(communications)]`  
        `MET[(alignment_metrics)]`  
        `PRO[(profiles)]`  
    `end`

    `%% Governance & Storage`  
    `subgraph E["📜 Governance & Storage"]`  
        `GOV[(flow-engine.md)]`  
        `LIB[(prompt-library.json)]`  
        `BAL[(ai-ethos + B.A.L.A.N.C.E. rules)]`  
    `end`

    `%% Relationships`  
    `U -->|enters reflection| FP`  
    `FP -->|triggers| UR`  
    `FP -->|fetches prompt| UP`  
    `UP -->|calls| GP`  
    `UR -->|posts reflection| AR`  
    `AR -->|uses| AI`  
    `AC -->|optional CLEAR analysis| AI`  
    `AB -->|optional boundary guidance| AI`  
    `GP -->|reads from| LIB`  
    `AR -->|writes summary/readiness| REF`  
    `FP -->|updates UI + phase| U`  
    `AR -->|updates metrics| MET`  
    `GOV -->|governs logic + tone| FP`  
    `BAL -->|informs| AB`

---

### **🔍 Diagram Overview**

| Layer | Role | Key Files |
| ----- | ----- | ----- |
| **User Layer** | Parent or professional reflecting on an issue | Mobile app UI |
| **Application Layer** | Manages phases, prompts, and readiness | `FlowProvider.tsx`, `usePrompt.ts`, `useReflection.ts` |
| **Edge Functions** | Execute AI reflection, CLEAR, and boundary logic | `ai-reflect`, `ai-clear`, `ai-balance`, `get-prompt` |
| **Database Layer** | Stores reflections, communication drafts, and metrics | `reflections`, `communications`, `alignment_metrics` |
| **Governance Layer** | Defines coaching voice, phase rules, and ethos | `flow-engine.md`, `prompt-library.json` |

---

### **💧 Flow Narrative**

1. **User Input** → The parent/professional enters a thought, frustration, or reflection.

2. **FlowProvider** captures context and phase (e.g., *issue*).

3. **useReflection** sends data to the **`ai-reflect` Edge Function**, which analyzes readiness, summarizes, and suggests next prompt/phase.

4. **Claude API** processes the reflection using the BeH2O® governance prompt.

5. **Supabase** stores the reflection, summary, and scores in the `reflections` table.

6. **usePrompt** or **get-prompt** retrieves the next reflective question from `prompt-library.json`.

7. **FlowProvider** updates UI and readiness; user sees next question and continues the reflective loop.

8. **Optional Functions**:

   * `ai-clear` refines listener-ready communication (CLEAR framework).

   * `ai-balance` produces B.A.L.A.N.C.E. boundary feedback.

9. **Metrics & Governance** ensure tone fidelity, child-impact focus, and ongoing coach oversight.

---

### **🧭 Key Principles Visualized**

* **Fluidity:** The app adapts phase transitions based on readiness, not sequence.

* **Accountability:** Every reflection loops through AI, governance, and human review.

* **Alignment:** All logic passes through BeH2O®’s core ethos — strength, stability, and flow.

---

Here’s your second visual diagram — a **Mermaid \+ Markdown Data & API Architecture Map** you can paste below the system flow in your `README.md`.

It shows how data, tables, and Edge Functions interact across Supabase — designed for technical clarity and pitch-deck storytelling.

---

## **🗄️ BeAligned™ Data & API Architecture**

`erDiagram`  
    `%% ======================`  
    `%% DATABASE ENTITIES`  
    `%% ======================`

    `USERS ||--o{ PROFILES : "has"`  
    `USERS ||--o{ REFLECTIONS : "creates"`  
    `USERS ||--o{ COMMUNICATIONS : "sends"`  
    `USERS ||--o{ COACH_FEEDBACK : "receives feedback"`  
    `USERS ||--o{ SUBSCRIPTIONS : "owns"`  
    `USERS ||--o{ CHILDREN : "parents"`

    `PROFILES {`  
        `uuid user_id PK`  
        `text first_name`  
        `text last_name`  
        `text preferred_name`  
        `text role`  
        `timestamptz created_at`  
    `}`

    `REFLECTIONS {`  
        `uuid id PK`  
        `uuid user_id FK`  
        `text phase`  
        `text content`  
        `jsonb ai_summary`  
        `numeric alignment_score`  
        `numeric readiness`  
        `timestamptz created_at`  
    `}`

    `COMMUNICATIONS {`  
        `uuid id PK`  
        `uuid user_id FK`  
        `text type`  
        `text channel`  
        `text message_body`  
        `numeric clear_score`  
        `timestamptz created_at`  
    `}`

    `COACH_FEEDBACK {`  
        `uuid id PK`  
        `uuid coach_id FK`  
        `uuid reflection_id FK`  
        `uuid communication_id FK`  
        `text feedback_text`  
        `text[] alignment_tags`  
        `timestamptz created_at`  
    `}`

    `CHILDREN {`  
        `uuid id PK`  
        `uuid parent_user_id FK`  
        `text name`  
        `date birth_date`  
        `jsonb wellbeing_indicators`  
    `}`

    `SUBSCRIPTIONS {`  
        `uuid id PK`  
        `uuid user_id FK`  
        `uuid institution_id FK`  
        `text plan_tier`  
        `text status`  
        `date renewal_date`  
    `}`

    `INSTITUTIONS {`  
        `uuid id PK`  
        `text name`  
        `text type`  
        `text contact_email`  
    `}`

    `ALIGNMENT_METRICS {`  
        `uuid id PK`  
        `uuid user_id FK`  
        `numeric alignment_score`  
        `numeric clear_score`  
        `numeric boundary_score`  
        `timestamptz created_at`  
    `}`

    `%% ======================`  
    `%% EDGE FUNCTION RELATIONSHIPS`  
    `%% ======================`

    `%% AI REFLECT`  
    `REFLECTIONS ||--|| AI_REFLECT : "created via"`  
    `AI_REFLECT {`  
        `string name "ai-reflect"`  
        `string description "Analyzes reflection, produces summary and readiness score"`  
    `}`

    `%% AI CLEAR`  
    `COMMUNICATIONS ||--|| AI_CLEAR : "enhanced by"`  
    `AI_CLEAR {`  
        `string name "ai-clear"`  
        `string description "Evaluates CLEAR communication (Concise, Listener-Ready, etc.)"`  
    `}`

    `%% AI BALANCE`  
    `REFLECTIONS ||--|| AI_BALANCE : "boundary guidance"`  
    `AI_BALANCE {`  
        `string name "ai-balance"`  
        `string description "Applies B.A.L.A.N.C.E. boundary logic"`  
    `}`

    `%% GET PROMPT`  
    `PROMPT_LIBRARY ||--|| GET_PROMPT : "loaded by"`  
    `GET_PROMPT {`  
        `string name "get-prompt"`  
        `string description "Fetches next reflection prompt from Supabase Storage"`  
    `}`

    `%% STORAGE GOVERNANCE`  
    `GOVERNANCE_FILES {`  
        `string flow_engine "flow-engine.md"`  
        `string prompt_library "prompt-library.json"`  
        `string ethos "governance/policies"`  
    `}`

    `GET_PROMPT ||--o{ PROMPT_LIBRARY : "reads"`  
    `AI_REFLECT ||--o{ GOVERNANCE_FILES : "references"`  
    `AI_CLEAR ||--o{ GOVERNANCE_FILES : "references"`  
    `AI_BALANCE ||--o{ GOVERNANCE_FILES : "references"`

---

### **🧠 Architecture Narrative**

| Layer | Description | Example Files |
| ----- | ----- | ----- |
| **Database (PostgreSQL)** | Stores all reflections, communications, and metrics under Row-Level Security | `/supabase/migrations/*.sql` |
| **AI Edge Functions** | Modular Claude-powered functions that handle specific BeAligned™ logic | `ai-reflect`, `ai-clear`, `ai-balance`, `get-prompt` |
| **Storage Governance** | Holds BeH2O® coaching system files and prompts used by AI models | `/governance/prompt-library.json`, `/governance/flow-engine.md` |
| **Metrics Layer** | Tracks alignment growth, communication health, and boundary patterns | `alignment_metrics` table |
| **Frontend Hooks** | Bridge app and backend to create reflective flow | `useReflection.ts`, `usePrompt.ts`, `FlowProvider.tsx` |

---

### **🧩 How to Explain This to Funders or Developers**

“BeAligned™ isn’t just an app — it’s an ecosystem where data, AI, and human governance interlock.  
 Each reflection passes through structured systems that reinforce BeH2O®’s ethos: reflection before reaction, clarity before communication, and alignment before action.”

Here’s your **Governance Stack Map** — a vertical visualization of how BeAligned™ encodes its *values → frameworks → governance → architecture → technology*.

Paste this right below the data architecture section in your `README.md`.

---

## **🧱 BeAligned™ Governance Stack Map**

`graph TD`  
    `%% ======================`  
    `%% VALUES & PURPOSE`  
    `%% ======================`  
    `A1["🌍 Purpose & Values Layer"]`  
    `A1:::layer --> A2["Safeguarding Childhoods\nBeH2O® Ethos"]`  
    `A2 --> A3["Strength (Beryllium) + Flow (Water)\nMindset before Behavior"]`

    `%% ======================`  
    `%% PHILOSOPHY & FRAMEWORKS`  
    `%% ======================`  
    `A3 --> B1["📚 Framework Layer"]`  
    `B1 --> B2["CLEAR Communication\n(Concise, Listener-Ready, Essential, Appropriate, Relevant)"]`  
    `B1 --> B3["B.A.L.A.N.C.E. Boundaries\n(Balanced, Aligned, Necessary, Constructive, Evolving)"]`  
    `B1 --> B4["Third Side Hosting (Ury)\nAlignment over Neutrality"]`

    `%% ======================`  
    `%% GOVERNANCE & ETHICS`  
    `%% ======================`  
    `B4 --> C1["🧭 Governance Layer"]`  
    `C1 --> C2["flow-engine.md\nDefines system behavior & coaching laws"]`  
    `C1 --> C3["prompt-library.json\nPhase prompts & re-prompts"]`  
    `C1 --> C4["ai-ethos policies\nNon-judgment, trauma-informed tone"]`  
    `C1 --> C5["Human-in-the-loop review\nMonthly coach audits for alignment"]`

    `%% ======================`  
    `%% LOGIC & ARCHITECTURE`  
    `%% ======================`  
    `C5 --> D1["🧠 Architecture Layer"]`  
    `D1 --> D2["FlowProvider.tsx\nPhase control + readiness gating"]`  
    `D1 --> D3["useReflection.ts\nAI summary + readiness scoring"]`  
    `D1 --> D4["usePrompt.ts\nDynamic prompt retrieval"]`  
    `D1 --> D5["Supabase Edge Functions\n(ai-reflect, ai-clear, ai-balance, get-prompt)"]`

    `%% ======================`  
    `%% DATA & TECHNOLOGY`  
    `%% ======================`  
    `D5 --> E1["💾 Data & Technology Layer"]`  
    `E1 --> E2["Supabase (PostgreSQL + RLS)\nreflections, communications, metrics"]`  
    `E1 --> E3["Supabase Storage\nGovernance + prompt library"]`  
    `E1 --> E4["Anthropic Claude 3.5\nAI reasoning engine"]`  
    `E1 --> E5["React Native (Expo)\nUser interface & state flow"]`

    `%% ======================`  
    `%% HUMAN FEEDBACK LOOP`  
    `%% ======================`  
    `E5 --> F1["🔁 Continuous Alignment Loop"]`  
    `F1 --> F2["User Reflection → AI Analysis → FlowProvider Update → Coach Oversight → Governance Refinement"]`

    `%% Styling`  
    `classDef layer fill:#e3f2fd,stroke:#90caf9,stroke-width:2px,color:#0d47a1,font-weight:bold;`  
    `classDef section fill:#f1f8e9,stroke:#aed581,stroke-width:1px,color:#33691e,font-weight:normal;`

---

### **🧩 Stack Narrative**

| Layer | Focus | Key Artifacts |
| ----- | ----- | ----- |
| **Values & Purpose** | Why the system exists — to safeguard childhoods | *BeH2O® Ethos* |
| **Frameworks** | The human rules and coaching patterns | CLEAR, B.A.L.A.N.C.E., Third Side |
| **Governance** | How values and frameworks are encoded | `flow-engine.md`, `prompt-library.json`, monthly reviews |
| **Architecture** | How logic moves through the app | React Context, Hooks, Edge Functions |
| **Technology** | How the system runs | Supabase \+ Anthropic \+ React Native |
| **Human Feedback Loop** | Continuous ethical recalibration | Certified BeH2O® Coach Audits |

---

### **💧 Key Insight**

**BeAligned™ isn’t an AI product — it’s a values system expressed through code.**  
 Every prompt, score, and reflection originates from the same place:  
 *Be strong like beryllium. Flow like water. Always safeguard childhoods.*

ast question \- if Robert asked "what is the heartbeat" of this platform or "what makes it tick" or "what is the magic", how would you respond

###### **ChatGPT said:**

That’s such a powerful and defining question — and it’s exactly the kind of moment that separates a *tech build* from a *movement*.

If Robert asked, *“What is the heartbeat of this platform?”* or *“What makes it tick?”* or *“What’s the magic?”* — here’s how you could answer, in Trina’s authentic voice and BeH2O® tone:

---

### **💙 The Heartbeat of BeAligned™**

The heartbeat of this platform isn’t code or AI — it’s *clarity meeting compassion*.  
 BeAligned™ takes what a skilled BeH2O® coach does in a room — holding space, asking the right question at the right time, and inviting reflection instead of reaction — and translates that into a digital system.

It’s not trying to replace the human, it’s trying to *teach the system to pause like one.*  
 That pause — that breath between stimulus and response — *is* the heartbeat.  
 Everything that happens inside BeAligned™ is designed around that single moment:  
 where fear softens, awareness rises, and alignment becomes possible.

---

### **⚙️ What Makes It Tick**

BeAligned™ “ticks” through an interplay of **structure and humanity**.  
 The structure comes from BeH2O® — strength, stability, and flow — encoded through CLEAR communication and B.A.L.A.N.C.E. boundaries.  
 The humanity comes from how the system listens: not to respond, but to understand.  
 That’s why every AI call passes through governance, readiness thresholds, and child-impact checks — because the magic isn’t in the model; it’s in how it’s *guided*.

Where other systems optimize for speed, BeAligned™ optimizes for *alignment.*  
 It doesn’t just document conflict — it transforms it.  
 That transformation — one reflection, one prompt, one pause at a time — is the magic.

---

Would you like me to write a **one-sentence “pitch version”** of this answer — something you could use in a keynote, deck slide, or opening line when asked that question live?

ChatGPT can make mistakes. Check important info.  
